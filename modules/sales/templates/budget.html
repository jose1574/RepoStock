{% extends "base.html" %}

{% block title %}Presupuesto{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Presupuesto</h1>

<div class="grid grid-cols-1 lg:grid-cols-[1fr_420px] gap-4">
    <!-- Columna izquierda -->
    <div class="space-y-4">
        <!-- Detalles del cliente -->
        <section id="client-info" class="border rounded-lg bg-white p-4 shadow-sm">
            <h2 class="text-lg font-semibold mb-2">Detalles del Cliente</h2>
            <div class="text-sm space-y-1">
                <p>Nombre: Juan Pérez</p>
                <p>Empresa: ACME Corp</p>
                <p>Contacto: juan.perez@acmecorp.com</p>
            </div>
        </section>

        <!-- Buscador de productos -->
        <section id="container-search-product" class="border rounded-lg bg-white p-4 shadow-sm">
            <h3 class="text-sm font-semibold mb-2">Buscador de Productos</h3>
            <label class="block text-xs mb-1" for="search-product">Buscar Producto</label>
            <div class="flex gap-2">
                <input type="text" id="search-product" name="search-product" placeholder="Ingrese el nombre o código del producto" class="border rounded px-2 py-1 w-full">
                <button id="search-product-button" class="bg-green-600 text-white px-3 py-1 rounded">Buscar</button>
            </div>
            <div id="modal-host"></div>
        </section>

        <!-- Sección detalles de producto y stocks -->
        <section id="section-product-detail" class="border rounded-lg bg-white p-4 shadow-sm">
            <h3 class="text-sm font-semibold mb-3">Sección detalles de producto</h3>
            <div id="product-info" class="space-y-3">
                <div id="product-description" class="border rounded p-3">
                    <div id="product-code" class="text-sm">Código: PRD001</div>
                    <div id="product-name" class="text-base font-medium">Nombre: Producto A</div>
                    <div id="prices-prices" class="grid grid-cols-2 gap-2 mt-2 text-sm">
                        <div id="product-offer-price">Precio Unitario: $15.00</div>
                        <div id="product-minimum-price">Precio Mínimo: $12.00</div>
                        <div id="product-higher-price">Precio Máximo: $18.00</div>
                        <div id="product-maximum-price">Precio Máximo: $19.00</div>
                    </div>
                </div>

                <div id="section-stock-info" class="border rounded p-3 text-sm">
                    <h4 class="font-semibold mb-2">Stock de depósitos</h4>
                    <p>Depósito 1: 150 unidades</p>
                    <p>Depósito 2: 200 unidades</p>
                    <p>Depósito 3: 100 unidades</p>
                    <h3 class="mt-2">Total: 450 unidades</h3>
                </div>

                <div class="flex items-center gap-2">
                    <label class="text-sm" for="quantity">Cantidad:</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" class="border rounded px-2 py-1 w-24">
                    <button id="add-to-budget" class="bg-blue-600 text-white px-3 py-1 rounded">Agregar al Presupuesto</button>
                </div>
            </div>
        </section>

        <!-- Imágenes de producto -->
        <section id="product-images" class="border rounded-lg bg-white p-4 shadow-sm">
            <h3 class="text-sm font-semibold mb-3">Imágenes de productos</h3>
            <div class="flex gap-3">
                <img src="/static/images/product_sample.jpg" alt="Imagen 1" class="w-24 h-24 object-cover rounded border">
                <img src="/static/images/product_sample.jpg" alt="Imagen 2" class="w-24 h-24 object-cover rounded border">
                <img src="/static/images/product_sample.jpg" alt="Imagen 3" class="w-24 h-24 object-cover rounded border">
            </div>
        </section>
    </div>

    <!-- Columna derecha: Presupuesto -->
    <aside class="border rounded-lg bg-white p-4 shadow-sm lg:sticky lg:top-4 h-fit">
        <h2 class="text-lg font-semibold mb-3">Presupuesto</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left">Código</th>
                        <th class="px-3 py-2 text-left">Nombre</th>
                        <th class="px-3 py-2 text-left">Unidad</th>
                        <th class="px-3 py-2 text-right">Precio</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-t">
                        <td class="px-3 py-2">PRD001</td>
                        <td class="px-3 py-2">Producto A</td>
                        <td class="px-3 py-2">Unidad</td>
                        <td class="px-3 py-2 text-right">$15.00</td>
                    </tr>
                    <tr class="border-t">
                        <td class="px-3 py-2">PRD002</td>
                        <td class="px-3 py-2">Producto B</td>
                        <td class="px-3 py-2">Unidad</td>
                        <td class="px-3 py-2 text-right">$30.00</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </aside>
</div>
{% endblock %}
{% block scripts %}
<script>
async function ensureProductModalLoaded() {
    const host = document.getElementById('modal-host');
    if (host.dataset.loaded === '1') return;
    const res = await fetch('{{ url_for("sales.product_search_modal") }}');
    const html = await res.text();
    // Inserta HTML y ejecuta scripts del parcial manualmente
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    // Append non-script nodes
    Array.from(doc.body.children).forEach(el => {
        if (el.tagName !== 'SCRIPT') host.appendChild(el);
    });
    // Ejecuta scripts creando nodos script nuevos
    Array.from(doc.querySelectorAll('script')).forEach(s => {
        const script = document.createElement('script');
        if (s.src) {
            script.src = s.src;
        } else {
            script.textContent = s.textContent || '';
        }
        document.body.appendChild(script);
    });
    host.dataset.loaded = '1';
}
document.getElementById('search-product-button').addEventListener('click', async () => {
    try {
        await ensureProductModalLoaded();
        const q = document.getElementById('search-product')?.value || '';
        if (typeof openProductModal === 'function') {
            openProductModal(q);
        } else {
            // reintenta una vez tras breve demora por scripts insertados dinámicamente
            setTimeout(() => {
                if (typeof openProductModal === 'function') {
                    openProductModal(q);
                } else {
                    alert('No se pudo abrir el buscador de productos.');
                }
            }, 50);
        }
    } catch (e) {
        console.error('Error abriendo modal de productos', e);
        alert('Error cargando el buscador de productos');
    }
});

// Implementación base de addItemViaAPI; ajusta según tus necesidades
async function addItemViaAPI(p, quantity=1) {
    try {
        const form = new URLSearchParams({
            code: p.code || '',
            description: p.description || '',
            unit_description: p.unit_description || '',
            unit_correlative: String(p.unit_correlative || ''),
            offer_price: String(p.offer_price || 0),
            quantity: String(quantity || 1),
        });
        const res = await fetch('{{ url_for("sales.api_budget_add_item") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: form.toString()
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Error al añadir');
        // TODO: inserta data.item en tu tabla de detalles y recalcula subtotal
        if (typeof closeProductModal === 'function') closeProductModal();
    } catch (e) {
        alert(e.message);
    }
}
</script>
{% endblock %}