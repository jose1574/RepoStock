{% extends 'base.html' %}


{% block content %}
<div class="max-w-6xl mx-auto py-6">
   <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-semibold text-gray-800">Orden de Recolección Manual</h2>
      <div>
         <div class="text-sm text-gray-600">Depósito origen: <strong class="text-lg font-semibold text-gray-800">{{ store_origin.description or 'N/D' }}</strong></div>
         <div class="text-sm text-gray-600">Depósito destino: <strong class="text-sm font-medium text-gray-700">{{ store_destination.description or 'N/D' }}</strong></div>
      </div>
       <div class="flex items-center gap-2">
          <button id="open-wizard-btn" type="button" class="px-3 py-1 text-sm rounded bg-teal-600 text-white hover:bg-teal-700">Cambiar depósitos</button>
       </div>
   </div>

   <form id="manual-collection-form" method="POST" action="{{ url_for('inventory.save_collection_order') }}">
      <input type="hidden" name="stock_store_origin" value="{{ origin_store_code or '' }}">
      <input type="hidden" name="store_code_destination" value="{{ destination_store_code or '' }}">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Columna izquierda: búsqueda y producto seleccionado -->
      <div class="lg:col-span-1 bg-white border rounded-lg p-4 shadow-sm">
         <label for="search-product-input" class="block text-sm font-medium text-gray-700 mb-2">Buscar Producto</label>
         <div class="flex gap-2">
            <input id="search-product-input" type="text" placeholder="Código o descripción (ej: tubo*mts)" autocomplete="off" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500" />
            <button id="search-product-button" type="button" class="px-3 py-2 rounded bg-teal-600 text-white text-sm hover:bg-teal-700 shadow">Buscar (F12)</button>
         </div>

         <div id="modal-host"></div>

         <div id="modal-details-product-selected" class="mt-4">
            <div class="text-sm text-gray-500">Producto seleccionado</div>
            <div id="product-info" class="mt-2 bg-gray-50 border rounded p-3">
               <div class="text-sm text-gray-800"><span id="product-code" class="font-medium"></span> <span id="product-description" class="text-gray-600"></span></div>
               <div id="product-stock-info" class="mt-2 text-xs text-gray-600">
                  <span id="product-stock-label">Stock disponible:</span>
                  <span id="product-stock" class="text-lg font-bold ml-1 text-gray-900"></span>
               </div>
                  <!-- Stock por depósitos: se llenará dinámicamente -->
                  <div id="product-stock-by-stores" class="mt-3 text-xs text-gray-700">
                     <div class="font-medium text-sm mb-1">Stock por depósito</div>
                     <!-- Mostrar siempre primero el depósito origen -->
                     <div id="product-stock-origin" class="flex items-center justify-between mb-1">
                        <div class="text-sm font-semibold text-gray-800">Dep. Origen: {{ store_origin.description if store_origin and store_origin.description else (origin_store_code or 'N/D') }}</div>
                        <div id="product-stock-origin-value" class="text-lg font-bold text-gray-900" data-main-stock="0">0</div>
                     </div>
                     <div id="product-stock-stores-list" class="space-y-1">
                        <!-- Items: cada uno será un div con store + stock (otros depósitos) -->
                     </div>
                  </div>
            </div>

               <div id="product-unit-select-wrapper" class="mt-3">
                  <label for="product-unit-select" class="text-sm text-gray-700">Unidad</label>
                  <select id="product-unit-select" class="w-full mt-1 border border-gray-300 rounded px-2 py-1 text-sm">
                     <!-- Opciones pobladas dinámicamente -->
                  </select>
               </div>

            <div id="product-quantity-input" class="mt-3 flex items-center gap-2">
               <label for="product-quantity" class="text-sm text-gray-700">Cantidad</label>
               <input type="number" id="product-quantity" min="0" step="0.001" value="1" class="w-28 border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none" />
               <button id="add-product-button" type="button" class="ml-auto px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700">Agregar</button>
            </div>
         </div>
      </div>

      <!-- Columna central: tabla de detalles (span 2) -->
      <div class="lg:col-span-2 bg-white border rounded-lg p-4 shadow-sm">
         <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-medium text-gray-800">Detalle Orden de Recoleccción</h3>
            <div class="text-xs text-gray-500">Añade y gestiona los productos seleccionados</div>
         </div>

         <div class="overflow-x-auto">
            <table class="min-w-full text-sm divide-y divide-gray-100">
               <thead class="bg-gray-50">
                  <tr>
                     <th class="px-3 py-2 text-left text-xs font-medium text-gray-600">Código</th>
                     <th class="px-3 py-2 text-left text-xs font-medium text-gray-600">Descripción</th>
                     <th class="px-3 py-2 text-left text-xs font-medium text-gray-600">Unidad</th>
                     <th class="px-3 py-2 text-left text-xs font-medium text-gray-600">Ubicación</th>
                     <th class="px-3 py-2 text-right text-xs font-medium text-gray-600">Cantidad</th>
                     <th class="px-3 py-2 text-right text-xs font-medium text-gray-600">Acciones</th>
                  </tr>
               </thead>
               <tbody id="details-products-tbody" class="bg-white divide-y divide-gray-100">
                  <!-- Filas agregadas dinámicamente -->
               </tbody>
            </table>
         </div>

         <div class="mt-4 flex items-center justify-between">
            <div id="details-summary" class="text-sm text-gray-600">Total ítems: <span id="details-count">0</span></div>
            <div class="flex gap-2">
               <button id="clear-selection" type="button" class="px-3 py-2 text-sm rounded border bg-white text-gray-700 hover:bg-gray-50">Limpiar</button>
               <button id="save-collection" type="submit" class="px-3 py-2 text-sm rounded bg-green-600 text-white hover:bg-green-700">Guardar Orden</button>
            </div>
         </div>
      </div>
      </div>
   </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(async function(){
   async function ensureProductsModalLoaded(){
      // Evitar insertar el partial dentro del formulario principal: siempre insertar en document.body
      if(document.getElementById('products-modal-panel')) return;
      try{
         const res = await fetch('{{ url_for("inventory.products_modal") }}');
         if(!res.ok) return;
         const html = await res.text();
         // Parsear el HTML para poder extraer scripts aunque estén fuera del panel
         try{
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const scripts = Array.from(doc.querySelectorAll('script'));
            // Crear un fragment con el contenido sin los <script>
            scripts.forEach(s => s.parentNode && s.parentNode.removeChild(s));
            const frag = document.createDocumentFragment();
            Array.from(doc.body.childNodes).forEach(n => frag.appendChild(document.importNode(n, true)));
            // Insertar el fragment en el body (modal y overlay)
            document.body.appendChild(frag);
            // Ejecutar los scripts extraídos en el contexto global
            scripts.forEach(s => {
               try{
                  const sc = document.createElement('script');
                  if(s.src){ sc.src = s.src; sc.async = false; document.body.appendChild(sc); }
                  else { sc.type = 'text/javascript'; sc.text = s.textContent || s.innerText || ''; document.body.appendChild(sc); }
               }catch(ex){ console.error('Error ejecutando script del partial:', ex); }
            });
         }catch(parseErr){
            // Fallback simple: insertar el HTML crudo en body
            document.body.insertAdjacentHTML('beforeend', html);
         }
      }catch(e){ console.error('Error cargando partial modal:', e); }
   }

   document.getElementById('search-product-button').addEventListener('click', async function(e){
      e.preventDefault();
      await ensureProductsModalLoaded();
      if(typeof openProductsModal === 'function') openProductsModal();
      else {
         const overlay = document.getElementById('products-modal-overlay');
         const panel = document.getElementById('products-modal-panel');
         if(overlay) overlay.classList.remove('hidden');
         if(panel) panel.classList.remove('hidden');
      }
   });

      // Permitir búsqueda rápida por ENTER en el input: buscar por código (main u other_code)
      const searchInput = document.getElementById('search-product-input');
      if(searchInput){
         searchInput.addEventListener('keydown', async function(e){
            if(e.key === 'Enter'){
               e.preventDefault();
               const val = (searchInput.value || '').trim();
               // Si el input está vacío, abrir el buscador modal
               if(!val){
                  await ensureProductsModalLoaded();
                  if(typeof openProductsModal === 'function') openProductsModal();
                  else {
                     const overlay = document.getElementById('products-modal-overlay');
                     const panel = document.getElementById('products-modal-panel');
                     if(overlay) overlay.classList.remove('hidden');
                     if(panel) panel.classList.remove('hidden');
                  }
                  return;
               }
               try{
                  // Usar el endpoint que devuelve todas las unidades (incluye unidades alternas)
                  const url = '{{ url_for("inventory.api_get_product_by_code_all_units") }}' + '?code=' + encodeURIComponent(val);
                  const res = await fetch(url);
                  if(res.status === 404){
                     // Producto no encontrado: limpiar y mostrar aviso
                     window.onInventoryProductSelected && window.onInventoryProductSelected({code: '', description: 'Producto no encontrado', total_stock: ''});
                     return;
                  }
                  if(!res.ok){
                     console.error('Error buscando producto:', res.status);
                     return;
                  }
                  const data = await res.json();
                  if(data && data.ok && data.product){
                     // Usar el handler global para poblar la UI
                     const p = data.product;
                     // Mapear claves a las esperadas por onInventoryProductSelected
                     const mapped = {
                        code: p.code,
                        description: p.description,
                        total_stock: p.total_stock,
                        unit_description: p.unit_description,
                        unit_correlative: p.unit_correlative,
                        // pasar todas las unidades (main + alternas) para poblar el select
                        units: p.units || []
                     };
                     window.onInventoryProductSelected && window.onInventoryProductSelected(mapped);
                     // limpiar input tras selección
                     searchInput.value = '';
                     // pequeña animación de highlight
                     const host = document.getElementById('modal-details-product-selected');
                     if(host){
                        host.animate([{background: '#fff9c4'}, {background: '#ffffff'}], {duration: 700});
                     }
                  } else {
                     window.onInventoryProductSelected && window.onInventoryProductSelected({code: '', description: 'Producto no encontrado', total_stock: ''});
                  }
               }catch(err){
                  console.error('Error en búsqueda rápida:', err);
               }
            }
         });
      }

      // Tecla global: F12 abre el modal de productos desde cualquier parte
      document.addEventListener('keydown', async function(e){
         try{
            if(e.key === 'F12'){
               e.preventDefault();
               await ensureProductsModalLoaded();
               if(typeof openProductsModal === 'function') openProductsModal();
               else {
                  const overlay = document.getElementById('products-modal-overlay');
                  const panel = document.getElementById('products-modal-panel');
                  if(overlay) overlay.classList.remove('hidden');
                  if(panel) panel.classList.remove('hidden');
               }
            }
         }catch(err){ console.error('Error opening products modal with F12:', err); }
      });

   // Estado local del producto seleccionado (para uso al agregar)
   let _currentSelectedProduct = null;

   // Función global (dentro del IIFE) para cargar y renderizar stocks por depósito
   async function loadProductStocks(productCode){
      try{
         const codesUrl = '{{ url_for("inventory.api_products_stocks_by_product") }}' + '?code=' + encodeURIComponent(productCode || '');
         const r = await fetch(codesUrl);
         const listEl = document.getElementById('product-stock-stores-list');
         const originVal = document.getElementById('product-stock-origin-value');
         if(!listEl || !originVal) return;
         if(!r.ok){
            listEl.innerHTML = '<div class="text-xs text-red-500">No se pudo obtener stock por depósitos</div>';
            originVal.dataset.mainStock = '0';
            originVal.textContent = 'N/D';
            return;
         }
         const data = await r.json();
         listEl.innerHTML = '';
         if(data && data.ok && Array.isArray(data.stocks)){
            // Guardar stocks por depósito en el producto seleccionado para validaciones posteriores
            if(_currentSelectedProduct) {
               _currentSelectedProduct.stocks = data.stocks;
               // Calcular suma total de stocks en todos los depósitos (tratando null/undefined como 0)
               try{
                  const sum = (data.stocks || []).reduce((acc, s) => acc + (s && s.stock ? Number(s.stock) : 0), 0);
                  _currentSelectedProduct.total_stock = Number(sum || 0);
               }catch(e){ /* noop */ }
            }

            // Determinar depósito origen dinámicamente desde el input hidden
            const originCode = (document.querySelector('input[name="stock_store_origin"]') || {}).value || '';

            // Buscar y renderizar origin primero
            let originFound = null;
            for(const s of data.stocks){
               try{
                  if(s && (s.is_origin || String(s.store_code) === String(originCode))){ originFound = s; break; }
               }catch(e){/* ignore */}
            }
            if(originFound){
               originVal.dataset.mainStock = (originFound.stock === null || originFound.stock === undefined) ? '0' : String(originFound.stock);
               originVal.textContent = originVal.dataset.mainStock;
               originVal.className = 'text-lg font-bold text-gray-900';
               // Resaltar visualmente el contenedor del depósito origen
               const originContainer = document.getElementById('product-stock-origin');
               if(originContainer){ originContainer.classList.add('bg-yellow-50','rounded','p-1'); }
            } else {
               // fallback: usar total_stock o mostrar N/D
               originVal.dataset.mainStock = '0';
               originVal.textContent = 'N/D';
               const originContainer = document.getElementById('product-stock-origin');
               if(originContainer){ originContainer.classList.remove('bg-yellow-50','rounded','p-1'); }
            }

            // Renderizar los demás depósitos excluyendo el origen
            for(const s of data.stocks){
               try{
                  if(originFound && (s && (s.is_origin || String(s.store_code) === String(originFound.store_code)))){ continue; }
               }catch(e){ /* continue */ }
               const div = document.createElement('div');
               div.className = 'flex items-center justify-between';
               const left = document.createElement('div');
               left.className = 'text-xs text-gray-700';
               left.textContent = (s.store_description || s.store_code || 'N/D');
               const right = document.createElement('div');
               right.dataset.mainStock = (s.stock === null || s.stock === undefined) ? '0' : String(s.stock);
               right.className = 'text-sm font-medium text-gray-800';
               right.textContent = right.dataset.mainStock;
               div.appendChild(left);
               div.appendChild(right);
               listEl.appendChild(div);
            }

            // Después de poblar la lista, recalcular la visualización del stock según la unidad seleccionada
            try{ applyUnitConversionToStocks(); }catch(e){/* noop */}
         } else {
            listEl.innerHTML = '<div class="text-xs text-gray-600">Sin datos</div>';
            originVal.dataset.mainStock = '0';
            originVal.textContent = 'N/D';
         }
      }catch(err){
         console.error('Error cargando stock por depósitos:', err);
      }
   }

             // --- Wizard modal (selección origen/destino) ---
             function ensureWizardModal(){
                   if(document.getElementById('mcw-overlay')) return;
                   const html = `
                   <div id="mcw-overlay" class="fixed inset-0 bg-black/40 z-50 hidden"></div>
                   <div id="mcw-panel" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
                      <div class="w-full max-w-2xl bg-white shadow-md rounded-lg p-6 border">
                         <h3 class="text-lg font-semibold text-gray-800 mb-2">Configurar Depósitos</h3>
                         <p class="text-sm text-gray-600 mb-3">Selecciona el depósito de origen y luego el de destino.</p>
                         <form id="mcw-form" class="space-y-4" onsubmit="return false;">
                            <div id="mcw-step-1" class="space-y-2">
                               <label for="mcw-origin" class="block text-sm font-medium text-gray-700">Depósito origen</label>
                               <select id="mcw-origin" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm">
                                  <option value=\"\">-- Selecciona origen --</option>
                                  {% for s in stores %}
                                  <option value=\"{{ s.code }}\">{{ s.description }} ({{ s.code }})</option>
                                  {% endfor %}
                               </select>
                            </div>
                            <div id="mcw-step-2" class="space-y-2 mt-2 hidden">
                               <label for="mcw-destination" class="block text-sm font-medium text-gray-700">Depósito destino</label>
                               <select id="mcw-destination" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm">
                                  <option value=\"\">-- Selecciona destino --</option>
                                  {% for s in stores %}
                                  <option value=\"{{ s.code }}\">{{ s.description }} ({{ s.code }})</option>
                                  {% endfor %}
                               </select>
                            </div>
                            <div class="mt-4 flex items-center justify-between">
                               <button id="mcw-back" type="button" class="px-3 py-2 rounded bg-gray-100 text-sm" disabled>Atrás</button>
                               <div class="flex gap-2">
                                  <button id="mcw-cancel" type="button" class="px-3 py-2 rounded bg-white border text-sm">Cancelar</button>
                                  <button id="mcw-next" type="button" class="px-3 py-2 rounded bg-teal-600 text-white text-sm">Siguiente</button>
                                  <button id="mcw-confirm" type="button" class="px-3 py-2 rounded bg-green-600 text-white text-sm hidden">Confirmar</button>
                               </div>
                            </div>
                         </form>
                      </div>
                   </div>
                   `;
                   document.body.insertAdjacentHTML('beforeend', html);
                   const ov = document.getElementById('mcw-overlay'); if(ov) ov.addEventListener('click', closeWizard);
             }

         function openWizard(){
             ensureWizardModal();
             document.getElementById('mcw-overlay').classList.remove('hidden');
             document.getElementById('mcw-panel').classList.remove('hidden');
             showStep(1);
         }

         function closeWizard(){
             const ov = document.getElementById('mcw-overlay');
             const pn = document.getElementById('mcw-panel');
             if(ov) ov.classList.add('hidden');
             if(pn) pn.classList.add('hidden');
         }

         function showStep(n){
             const s1 = document.getElementById('mcw-step-1');
             const s2 = document.getElementById('mcw-step-2');
             const back = document.getElementById('mcw-back');
             const next = document.getElementById('mcw-next');
             const confirm = document.getElementById('mcw-confirm');
             if(n===1){ s1.classList.remove('hidden'); s2.classList.add('hidden'); back.disabled = true; next.classList.remove('hidden'); confirm.classList.add('hidden'); }
             else { s1.classList.add('hidden'); s2.classList.remove('hidden'); back.disabled = false; next.classList.add('hidden'); confirm.classList.remove('hidden'); }
         }

         async function applyWizardSelection(){
             const origin = document.getElementById('mcw-origin').value;
             const destination = document.getElementById('mcw-destination').value;
             if(!origin || !destination){ alert('Selecciona origen y destino'); return; }
             try{
                const fd = new FormData(); fd.append('origin', origin); fd.append('destination', destination);
                const res = await fetch('{{ url_for("inventory.api_manual_collection_order_set_stores") }}', { method: 'POST', body: fd, credentials: 'same-origin', headers: {'X-Requested-With':'XMLHttpRequest'} });
                const data = await res.json();
                if(!data || !data.ok){ alert('No se pudo guardar la selección: '+(data && data.error? data.error : 'error')); return; }
                // actualizar labels y hidden inputs en la UI
                const originDesc = (document.querySelector('#mcw-origin option:checked') || {}).textContent || origin;
                const destDesc = (document.querySelector('#mcw-destination option:checked') || {}).textContent || destination;
                // actualizar UI: los dos labels visibles (primer .text-sm .strong y el segundo strong.text-sm)
                const originLabel = document.querySelector('.text-sm.text-gray-600 strong');
                if(originLabel) originLabel.textContent = originDesc;
                const destLabel = document.querySelector('.text-sm.text-gray-600 strong.text-sm');
                if(destLabel) destLabel.textContent = destDesc;
                // hidden inputs
                const hiddenOrigin = document.querySelector('input[name="stock_store_origin"]');
                const hiddenDest = document.querySelector('input[name="store_code_destination"]');
                if(hiddenOrigin) hiddenOrigin.value = origin;
                if(hiddenDest) hiddenDest.value = destination;
                // actualizar el título fijo del depósito origen dentro del panel de stock
                try{
                   const originHeader = document.querySelector('#product-stock-origin .text-sm.font-semibold');
                   if(originHeader) originHeader.textContent = 'Dep. Origen: ' + (originDesc || origin);
                }catch(e){/* noop */}
                // Si hay un producto seleccionado, recargar su stock para reflejar el nuevo depósito origen
                try{
                   if(_currentSelectedProduct && _currentSelectedProduct.code){
                      // llamada a la función definida más arriba que carga y renderiza stocks
                      if(typeof loadProductStocks === 'function') loadProductStocks(_currentSelectedProduct.code);
                   }
                }catch(e){ console.error('Error recargando stocks tras cambio de depósito', e); }
                // Cerrar wizard y recargar la página para asegurar que la sesión y la UI se sincronicen
                closeWizard();
                try{ window.location.reload(); }catch(e){ /* noop */ }
             }catch(e){ console.error('Error guardando selección wizard', e); alert('Error guardando selección'); }
         }

         // Wire buttons after injection
         document.addEventListener('click', function(e){
             if(e.target && e.target.id === 'open-wizard-btn'){ e.preventDefault(); openWizard(); }
             if(e.target && e.target.id === 'mcw-next'){ e.preventDefault();
                   // validate origin selected
                   const o = document.getElementById('mcw-origin').value; if(!o){ alert('Selecciona el depósito de origen antes de continuar'); return; }
                   // populate destination options excluding origin
                   const dest = document.getElementById('mcw-destination'); const opts = Array.from(dest.options);
                   opts.forEach(opt => { opt.hidden = (opt.value === o); });
                   showStep(2);
             }
             if(e.target && e.target.id === 'mcw-back'){ e.preventDefault(); showStep(1); }
             if(e.target && e.target.id === 'mcw-cancel'){ e.preventDefault(); closeWizard(); }
             if(e.target && e.target.id === 'mcw-confirm'){ e.preventDefault(); applyWizardSelection(); }
         });


   // Si el usuario presiona Enter en el input de cantidad, actuar como si presionara 'Agregar'
   const qtyInputEl = document.getElementById('product-quantity');
   if(qtyInputEl){
      qtyInputEl.addEventListener('keydown', function(e){
         if(e.key === 'Enter'){
            e.preventDefault();
            const addBtn = document.getElementById('add-product-button');
            if(addBtn) addBtn.click();
         }
      });
   }

   // Handler global cuando se selecciona producto desde el modal
   window.onInventoryProductSelected = function(product){
      if(!product) return;
      _currentSelectedProduct = product;
      const codeEl = document.getElementById('product-code');
      const descEl = document.getElementById('product-description');
      const stockEl = document.getElementById('product-stock');
      const unitSelect = document.getElementById('product-unit-select');
      if(codeEl) codeEl.textContent = product.code || '';
      if(descEl) descEl.textContent = product.description || '';
      // Inicializar total_stock en el producto seleccionado (puede ser reemplazado por la suma por depósitos tras la llamada)
      if(!_currentSelectedProduct) _currentSelectedProduct = {};
      _currentSelectedProduct.total_stock = Number(product.total_stock ?? product.stock ?? 0) || 0;

      // Helper para poblar el select con una lista de unidades
      function populateUnitSelect(unitsList){
         if(!unitSelect) return;
         unitSelect.innerHTML = '';
         const units = unitsList || [];
         if(units.length === 0){
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = product.unit_description || 'Unidad';
            unitSelect.appendChild(opt);
            return;
         }
         units.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.correlative || u.unit_code || '';
            opt.textContent = (u.unit_description || u.unit_code || '') + (u.main_unit ? ' (Principal)' : '');
            if(u.conversion_factor !== undefined && u.conversion_factor !== null) opt.dataset.conv = u.conversion_factor;
            if(u.unit_code) opt.dataset.code = u.unit_code;
            unitSelect.appendChild(opt);
         });
      }

      // Poblamos el select de unidades: si el objeto recibido no trae unidades,
      // hacemos una llamada al endpoint que devuelve todas las unidades disponibles.
      const incomingUnits = product.units || [];
      if((!incomingUnits || incomingUnits.length === 0) && product.code){
         // llamada asíncrona para obtener todas las unidades
         (async () => {
            try{
               const resp = await fetch('{{ url_for("inventory.api_get_product_by_code_all_units") }}' + '?code=' + encodeURIComponent(product.code));
               if(resp.ok){
                  const data = await resp.json();
                  if(data && data.ok && data.product){
                     populateUnitSelect(data.product.units || []);
                     try{ applyUnitConversionToStocks(); }catch(e){/* noop */}
                     return;
                  }
               }
            }catch(e){
               console.error('Error al obtener unidades adicionales:', e);
            }
            // fallback: usar lo que venga (aunque esté vacío)
            populateUnitSelect(incomingUnits);
         })();
      } else {
         populateUnitSelect(incomingUnits);
         try{ applyUnitConversionToStocks(); }catch(e){/* noop */}
      }

      // Cargar stocks inicialmente para el producto actual (usa la función global loadProductStocks)
      (async function(){ if(product && product.code) await loadProductStocks(product.code); })();
   };

   // Añadir producto a la lista de detalles cuando se presiona 'Agregar'
   document.getElementById('add-product-button').addEventListener('click', function(e){
      e.preventDefault();
      const code = (document.getElementById('product-code') || {}).textContent || '';
      const desc = (document.getElementById('product-description') || {}).textContent || '';
      const qtyInput = document.getElementById('product-quantity');
      const qty = qtyInput ? (qtyInput.value || '0') : '0';
      const unitSelect = document.getElementById('product-unit-select');
      const selectedOption = unitSelect ? unitSelect.options[unitSelect.selectedIndex] : null;
      const unitText = selectedOption ? selectedOption.textContent : '';
      const unitCode = selectedOption ? (selectedOption.dataset.code || selectedOption.value) : '';

      if(!code){
         return alert('Seleccione primero un producto válido');
      }

         // Validación de cantidad: si tenemos stock por depósito, validar contra el depósito origen
         try{
              const originCode = (document.querySelector('input[name="stock_store_origin"]') || {}).value || '';
            let available = null;
            if(_currentSelectedProduct && Array.isArray(_currentSelectedProduct.stocks)){
               const match = _currentSelectedProduct.stocks.find(s => String(s.store_code) === String(originCode) || s.is_origin);
               if(match && (match.stock !== null && match.stock !== undefined)) available = Number(match.stock);
            }
            // Fallback a total_stock si no hay detalle por depósito
            if(available === null && _currentSelectedProduct){
               const t = _currentSelectedProduct.total_stock ?? _currentSelectedProduct.stock;
               if(t !== null && t !== undefined) available = Number(t);
            }
            const wanted = parseFloat(String(qty).replace(',', '.')) || 0;
            // Tener en cuenta la unidad seleccionada: si la opción tiene conversion_factor, el stock disponible
            // debe mostrarse y compararse en la unidad alterna (stock_alt = stock_main / conversion_factor)
            try{
               const unitSel = document.getElementById('product-unit-select');
               const selOpt = unitSel ? unitSel.options[unitSel.selectedIndex] : null;
               const conv = selOpt && selOpt.dataset && selOpt.dataset.conv ? parseFloat(selOpt.dataset.conv) : 1;
               if(available !== null && !Number.isNaN(available) && conv && !Number.isNaN(conv) && conv > 0){
                  const availableAlt = available / conv;
                  if(wanted > availableAlt){
                     return alert(`Cantidad inválida: la cantidad no puede ser mayor al stock disponible (${availableAlt}) en el depósito origen para la unidad seleccionada.`);
                  }
               } else {
                  if(available !== null && !Number.isNaN(available)){
                     if(wanted > available){
                        return alert(`Cantidad inválida: la cantidad no puede ser mayor a el stock disponible hay (${available}) en el depósito origen.`);
                     }
                  }
               }
            }catch(e){ console.error('Error aplicando conversion en validación:', e); }
            if(wanted <= 0){
               return alert('La cantidad debe ser mayor a 0');
            }
         }catch(valErr){ console.error('Error validando cantidad:', valErr); }

      // Evitar duplicados: si ya existe una fila para este código y unidad, aumentar cantidad
      const tbody = document.getElementById('details-products-tbody');
      const existingRow = tbody.querySelector(`tr[data-code="${code}"][data-unit="${unitCode}"]`);
      if(existingRow){
         const qtyEl = existingRow.querySelector('.row-qty');
         const newQty = parseFloat((qtyEl.textContent || '0').replace(',', '.')) + parseFloat((qty || '0').replace(',', '.'));
         qtyEl.textContent = String(newQty);
         // actualizar hidden input correspondiente
         const hiddenQty = existingRow.querySelector(`input[name="to_transfer_${code}"]`);
         if(hiddenQty) hiddenQty.value = String(newQty);
      } else {
         const tr = document.createElement('tr');
         tr.dataset.code = code;
         tr.dataset.unit = unitCode || '';
          tr.innerHTML = `
            <td class="px-3 py-2">${code}<input type="hidden" name="selected_products" value="${code}"></td>
            <td class="px-3 py-2">${desc}</td>
            <td class="px-3 py-2">${unitText}</td>
            <td class="px-3 py-2">-</td>
            <td class="px-3 py-2 text-right"><span class="row-qty">${qty}</span>
               <input type="hidden" name="to_transfer_${code}" value="${qty}">
               <input type="hidden" name="unit_for_${code}" value="${selectedOption ? selectedOption.value : ''}">
            </td>
            <td class="px-3 py-2 text-right"><button type="button" class="row-remove px-2 py-1 rounded border text-sm">Eliminar</button></td>
          `;
         tbody.appendChild(tr);

         // eliminar handler
         tr.querySelector('.row-remove').addEventListener('click', function(ev){
            ev.preventDefault();
            tr.remove();
            updateDetailsCount();
         });

            // Interceptar submit del formulario para crear orden vía AJAX,
            // abrir PDF en nueva pestaña y redirigir la página actual.
            const form = document.getElementById('manual-collection-form');
            if(form){
               form.addEventListener('submit', async function(e){
                  e.preventDefault();
                  // Validar que haya al menos un item
                  const rows = document.querySelectorAll('#details-products-tbody tr');
                  if(!rows || rows.length === 0){
                     return alert('Agrega al menos un producto antes de guardar la orden');
                  }
                  try{
                     const fd = new FormData(form);
                     const res = await fetch('{{ url_for("inventory.manual_collection_order_create_ajax") }}', {
                        method: 'POST',
                        body: fd,
                        credentials: 'same-origin',
                        headers: {
                           'X-Requested-With': 'XMLHttpRequest'
                        }
                     });
                     if(!res.ok){
                        const txt = await res.text();
                        console.error('Error creando orden (ajax):', res.status, txt);
                        return alert('Error creando la orden. Revisa la consola para más detalles.');
                     }
                     const data = await res.json();
                     if(data && data.ok){
                        // Abrir PDF en nueva pestaña
                        const pdfUrl = data.pdf_url;
                        window.open(pdfUrl, '_blank');
                        // Redirigir la pestaña actual a la ruta de selección
                        const redirectTo = data.redirect || '{{ url_for("inventory.select_store_manual_collection_order") }}';
                        window.location.href = redirectTo;
                     } else {
                        console.error('Respuesta inválida al crear orden:', data);
                        alert('Error creando la orden: ' + (data && data.error ? data.error : 'error desconocido'));
                     }
                  }catch(err){
                     console.error('Error en submit AJAX:', err);
                     alert('Error creando la orden. Revisa la consola para más detalles.');
                  }
               });
            }
      }

      // limpiar cantidad a 1 por defecto
      if(qtyInput) qtyInput.value = 1;
      updateDetailsCount();
   });

   // Función que aplica la conversión de unidad a los elementos de stock mostrados
   function applyUnitConversionToStocks(){
      const unitSel = document.getElementById('product-unit-select');
      const selOpt = unitSel ? unitSel.options[unitSel.selectedIndex] : null;
      const conv = selOpt && selOpt.dataset && selOpt.dataset.conv ? parseFloat(selOpt.dataset.conv) : 1;
      const stockLabelEl = document.getElementById('product-stock');
      // Actualizar lista por depósitos
      const listEl = document.getElementById('product-stock-stores-list');
      if(listEl){
         Array.from(listEl.children).forEach(row => {
            try{
               const right = row.children[1];
               const main = right && right.dataset && right.dataset.mainStock ? parseFloat(right.dataset.mainStock) : 0;
               let display = main;
               if(conv && !Number.isNaN(conv) && conv > 0){ display = main / conv; }
               // Mostrar sin muchos decimales si es entero, sino con hasta 3 decimales
               const txt = (Math.abs(display - Math.round(display)) < 1e-9) ? String(Math.round(display)) : String(Number(display.toFixed(3)));
               right.textContent = txt;
            }catch(e){/* ignore */}
         });
      }
      // Actualizar el elemento fijo de depósito origen si existe
      const originValEl = document.getElementById('product-stock-origin-value');
      if(originValEl){
         try{
            const mainOrigin = originValEl.dataset && originValEl.dataset.mainStock ? parseFloat(originValEl.dataset.mainStock) : 0;
            let displayOrigin = mainOrigin;
            if(conv && !Number.isNaN(conv) && conv > 0){ displayOrigin = mainOrigin / conv; }
            const txto = (Math.abs(displayOrigin - Math.round(displayOrigin)) < 1e-9) ? String(Math.round(displayOrigin)) : String(Number(displayOrigin.toFixed(3)));
            originValEl.textContent = txto;
         }catch(e){/* ignore */}
      }
      // Actualizar label de stock total (usar _currentSelectedProduct.total_stock si existe)
      if(_currentSelectedProduct){
         const mainTotal = Number(_currentSelectedProduct.total_stock ?? _currentSelectedProduct.stock ?? 0);
         let displayTotal = mainTotal;
         if(conv && !Number.isNaN(conv) && conv > 0){ displayTotal = mainTotal / conv; }
         const txt = (Math.abs(displayTotal - Math.round(displayTotal)) < 1e-9) ? String(Math.round(displayTotal)) : String(Number(displayTotal.toFixed(3)));
         if(stockLabelEl) stockLabelEl.textContent = txt;
      }
   }

   // Escuchar cambios de unidad para recalcular el stock mostrado
   const unitSelectEl = document.getElementById('product-unit-select');
   if(unitSelectEl){
      unitSelectEl.addEventListener('change', function(e){
         try{ applyUnitConversionToStocks(); }catch(er){ console.error(er); }
      });
   }

   function updateDetailsCount(){
      const cnt = document.querySelectorAll('#details-products-tbody tr').length;
      const el = document.getElementById('details-count');
      if(el) el.textContent = String(cnt);
   }

})();
</script>
{% endblock %}