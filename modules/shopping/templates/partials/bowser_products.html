<!-- Modal for Product Search (Tailwind) -->
<div id="product-search-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-black/50 transition-opacity" aria-hidden="true"></div>

    <!-- Modal panel -->
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-white rounded-lg shadow-xl transform transition-all flex flex-col max-h-[90vh]">
            
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900" id="modal-title">Buscar Productos</h3>
                <button type="button" class="text-gray-400 hover:text-gray-500 focus:outline-none" onclick="closeProductSearchModal()">
                    <span class="sr-only">Cerrar</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Body -->
            <div class="p-4 space-y-4 flex-1 overflow-hidden flex flex-col">
                <div class="flex gap-2">
                    <input type="text" id="productSearchInput" class="flex-1 border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Buscar por c贸digo o descripci贸n (use * para filtros)...">
                    <button type="button" id="btnSearchProducts" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                        Buscar
                    </button>
                </div>

                <div class="border rounded-md overflow-auto flex-1">
                    <table class="min-w-full divide-y divide-gray-200 text-sm" id="productsResultsTable">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">C贸digo: </th>
                                <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">Descripci贸n</th>
                                <th class="px-4 py-3 text-right font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                <th class="px-4 py-3 text-right font-medium text-gray-500 uppercase tracking-wider">Costo</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t bg-gray-50 flex justify-end rounded-b-lg">
                <button type="button" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-md text-sm font-medium shadow-sm" onclick="closeProductSearchModal()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>

let onProductSelectedCallback = null;

    // Expose explicitly to window
    window.openProductSearchModal = function(callback) {
        console.log('openProductSearchModal called');
        onProductSelectedCallback = callback;
        const modal = document.getElementById('product-search-modal');
        if (modal) {
            modal.classList.remove('hidden');
            const input = document.getElementById('productSearchInput');
            if (input) {
                input.value = '';
                input.focus();
            }
            
            if (typeof window.searchProducts === 'function') {
                window.searchProducts();
            } else {
                console.warn('window.searchProducts is not defined yet');
            }
        } else {
            console.error('Modal element product-search-modal not found');
        }
    }

    // Also keep the function declaration for local scope if needed, or just rely on window assignment
    // But to be safe and match previous usage:
    const openProductSearchModal = window.openProductSearchModal;

    window.closeProductSearchModal = function() {
        const modal = document.getElementById('product-search-modal');
        if (modal) modal.classList.add('hidden');
        onProductSelectedCallback = null;
    }
    // Alias for safety
    const closeProductSearchModal = window.closeProductSearchModal;

    document.addEventListener('DOMContentLoaded', function() {
        const btnSearch = document.getElementById('btnSearchProducts');
        const inputSearch = document.getElementById('productSearchInput');
        const tableBody = document.querySelector('#productsResultsTable tbody');
        const tableContainer = document.querySelector('#productsResultsTable').parentElement;

        let _offset = 0;
        const _limit = 50;
        let _loading = false;
        let _hasMore = true;

        function searchProducts(reset = true) {
            const query = inputSearch.value.trim();
            const coin = '02'; // Default coin

            if (reset) {
                _offset = 0;
                _hasMore = true;
                tableBody.innerHTML = '';
            }

            if (_loading || !_hasMore) return;
            _loading = true;

            // Show loading indicator only if resetting or if it's the first load
            if (reset) {
                tableBody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-gray-500">Buscando...</td></tr>';
            }

            fetch(`/shopping/api/products/search?q=${encodeURIComponent(query)}&coin=${coin}&limit=${_limit}&offset=${_offset}`)
                .then(response => response.json())
                .then(data => {
                    if (reset) {
                        tableBody.innerHTML = '';
                    }
                    
                    if (data.ok && data.items && data.items.length > 0) {
                        data.items.forEach(product => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50 cursor-pointer';
                            const cost = parseFloat(product.maximum_price).toFixed(2);
                            
                            row.innerHTML = `
                                <td class="px-4 py-2 whitespace-nowrap text-gray-900">${product.code}</td>
                                <td class="px-4 py-2 text-gray-900">${product.description}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-right text-gray-900">${product.stock}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-right text-gray-900">${cost}</td>
                            `;
                            
                            // Add click event to the row
                            row.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                if (onProductSelectedCallback) {
                                    onProductSelectedCallback(product.code);
                                }
                                
                                closeProductSearchModal();
                            });
                            
                            tableBody.appendChild(row);
                        });

                        _offset += data.items.length;
                        if (data.items.length < _limit) {
                            _hasMore = false;
                        }
                    } else {
                        if (reset) {
                            tableBody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-gray-500">No se encontraron productos</td></tr>';
                        }
                        _hasMore = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (reset) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-red-500">Error al buscar productos</td></tr>';
                    }
                })
                .finally(() => {
                    _loading = false;
                });
        }

        // Infinite scroll
        tableContainer.addEventListener('scroll', function() {
            if (tableContainer.scrollTop + tableContainer.clientHeight >= tableContainer.scrollHeight - 50) {
                searchProducts(false);
            }
        });

        // Expose searchProducts to global scope so it can be called when modal opens
        window.searchProducts = () => searchProducts(true);

        // Debounce function to limit API calls
        let debounceTimer;
        const debounce = (func, delay) => {
            return (...args) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // Incremental search on input
        inputSearch.addEventListener('input', debounce(function() {
            searchProducts(true);
        }, 300));

        btnSearch.addEventListener('click', () => searchProducts(true));
    });
    // funcion para devolver el stock de un producto

</script>
