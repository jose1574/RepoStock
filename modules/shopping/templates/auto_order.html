{% extends 'base.html' %}

{% block title %}Orden de Compra Automatica{% endblock %}
{% block content %}
<div class="w-full p-4">
    <h1 class="text-2xl font-bold mb-4 text-gray-800">Orden de Compra Automática</h1>

    <!-- Provider Selection Form -->
    <div id="provider-selection-form"
        class="bg-white p-6 rounded-lg shadow-md border border-gray-200 max-w-2xl mx-auto">
        <h2 class="text-lg font-semibold mb-4 text-gray-700">Seleccionar Proveedor</h2>
        <div class="flex gap-4 items-end">
            <div class="flex-1">
                <label for="provider-code-input" class="block text-sm font-medium text-gray-700 mb-1">Código de
                    Proveedor</label>
                <div class="flex gap-2">
                    <input type="text" id="provider-code-input"
                        class="flex-1 border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Ingrese código o busque...">
                    <button id="btn-search-provider"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Buscar
                    </button>
                </div>
            </div>
        </div>
        <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Proveedor</label>
            <input type="text" id="provider-name-display"
                class="w-full border rounded px-3 py-2 text-sm bg-gray-50 text-gray-600" readonly placeholder="---">
        </div>

        <div class="mt-6 flex justify-end">
            <button id="btn-load-products" disabled
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Cargar Productos
            </button>
        </div>


        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden mt-6">
            <div class="relative w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div class="absolute top-0 h-4 bg-blue-600 rounded-full progress-bar-value"></div>
            </div>
            <p class="text-center text-sm font-medium text-gray-600 mt-2 animate-pulse">Buscando productos, por favor
                espere...</p>
            <style>
                @keyframes indeterminate {
                    0% {
                        left: -35%;
                        width: 35%;
                    }

                    60% {
                        left: 100%;
                        width: 10%;
                    }

                    100% {
                        left: 100%;
                        width: 10%;
                    }
                }

                .progress-bar-value {
                    animation: indeterminate 1.5s infinite linear;
                }
            </style>
        </div>
    </div>

    <!-- Products Table (Hidden initially) -->
    <div id="products-table-container" class="hidden mt-6 bg-white rounded-lg shadow border border-gray-200">
        <div class="p-4 border-b flex justify-between items-stretch bg-gray-50 rounded-t-lg">

            <div id="section-provider" class="flex-shrink-0 basis-1/3 h-full" style="min-width:30%;">
                <div class="lg:col-span-3 bg-white rounded-lg shadow p-3 border border-gray-200 flex flex-col h-full">
                    <h2 class="text-base font-semibold mb-2 text-gray-700 border-b pb-1">Datos del Proveedor</h2>
                    <div id="provider-info" class="space-y-2 text-xs flex-1">
                        <p id="selected-provider-label" class="text-sm text-gray-500">Proveedor: ---</p>
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                            <span class="text-gray-500">Días Crédito:</span>
                            <input type="number" id="input-provider-credit-days"
                                class="w-16 border rounded px-1 py-0.5 text-right text-xs focus:ring-2 focus:ring-blue-500 outline-none"
                                value="{{ provider.credit_days if provider else 0 }}" min="0">
                        </div>
                        <div id="coins" class="flex justify-between items-center border-b border-gray-100 pb-1">
                            <span class="text-gray-500">Moneda:</span>
                            <select id="select-coin"
                                class="w-32 border rounded px-1 py-0.5 text-xs focus:ring-2 focus:ring-blue-500 outline-none">
                                {% for coin in coins %}
                                <option value="{{ coin.code }}" {% if coin.code==default_coin %}selected{% endif %}>{{
                                    coin.description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-stores" class="flex-shrink-0 basis-1/4 h-full" style="min-width:25%;">
                <div class="bg-white rounded-lg shadow p-3 border border-gray-200 flex flex-col h-full">
                    <h2 class="text-base font-semibold mb-2 text-gray-700 border-b pb-1">Selecciona Depósitos</h2>
                    <div class="space-y-2 text-xs">
                        {% if stores %}
                        {% for store in stores %}
                        <label class="flex items-center">
                            <input type="checkbox" value="{{ store.code }}" class="store-checkbox mr-2" checked>
                            {{ store.description }}
                        </label>
                        {% endfor %}
                        {% else %}
                        <p class="text-xs text-gray-500">No hay depósitos disponibles.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div id="search-product-section" class="h-full" style="min-width:25%">
                <div class="bg-white rounded-lg shadow p-3 border border-gray-200 flex flex-col h-full">
                    <h2 class="text-base font-semibold mb-2 text-gray-700 border-b pb-1">Buscar Producto</h2>
                    <div class="flex items-center gap-2 mt-auto">
                        <input type="text" id="input-search-product" class="flex-1 border rounded px-3 py-2 text-sm"
                            placeholder="Buscar en la tabla...">
                        <button id="button-search-product" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-medium">
                            Buscar
                        </button>
                    </div>
                </div>
            </div>
            <button id="btn-change-provider" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                Cambiar Proveedor
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-100 text-gray-600 font-medium border-b">
                    <tr>
                        <th class="px-4 py-3 text-center"><input type="checkbox" id="select-all-products"
                                title="Seleccionar todos"></th>
                        <th class="px-4 py-3">Código</th>
                        <th class="px-4 py-3">Descripción</th>
                        <th class="px-4 py-3">Departamento</th>
                        <th class="px-4 py-3">Unidad</th>
                        <th class="px-4 py-3">Fecha de ultima Compra</th>
                        <th class="px-4 py-3">Existencia Minima</th>
                        <th class="px-4 py-3">Existencia Maxima</th>
                        <th class="px-4 py-3">Existencia actual</th>
                        <th class="px-4 py-3 text-right">Último Costo</th>
                        <th class="px-4 py-3 text-center">Última Compra</th>
                        <th class="px-4 py-3 text-center">
                            Cantidad a comprar
                        </th>
                    </tr>
                </thead>
                <tbody id="products-table-body" class="divide-y divide-gray-100">
                    <!-- Rows will be populated by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Include Provider Search Modal -->
{% include 'partials/browser_providers.html' %}
<!-- Include Product Search Modal -->
{% include 'partials/bowser_products.html' %}


<script>
    // Handler mínimo para selección de producto desde el modal
    function handleProductSelection(code) {
        try {
            if (!code) return;
            console.log('Producto seleccionado desde modal:', code);
            // Fetch al endpoint para obtener el producto con el mismo shape que los demás
            fetch(`/shopping/api/products/history_by_code/${encodeURIComponent(code)}`)
                .then(res => res.json())
                .then(data => {
                    if (!data || !data.ok || !data.item) {
                        alert(data && data.error ? data.error : 'Producto no encontrado');
                        return;
                    }
                    const newItem = data.item;
                    // Marcar para resaltar en la tabla
                    newItem.highlight = true;
                    // Inicializar items si no existen
                    if (!Array.isArray(currentItems)) {
                        currentItems = [];
                    }
                    // Insertar al inicio y re-renderizar
                    currentItems = [newItem, ...currentItems];
                    renderTable(currentItems);
                })
                .catch(err => {
                    console.error('Error obteniendo producto por código:', err);
                    alert('Error al obtener el producto.');
                });
        } catch (e) {
            console.error('Error en handleProductSelection:', e);
        }
    }
        
        // Product Search Button Handler
        const btnProduct = document.getElementById('button-search-product');
        if (btnProduct) {
            btnProduct.addEventListener('click', function (e) {
                e.preventDefault();
                console.log('Click en buscar producto');
                if (typeof openProductSearchModal === 'function') {
                    console.log('Abriendo modal de productos...');
                    openProductSearchModal(handleProductSelection);
                } else {
                    console.error('openProductSearchModal no está definida');
                    alert('Error: La función para abrir el modal no está cargada.');
                }
            });
        } else {
            console.error('Button button-search-product not found');
        }

        // Input Enter Key Handler
        const inputProduct = document.getElementById('input-search-product');
        if (inputProduct) {
            inputProduct.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = this.value.trim();
                    if (query) {
                        handleProductSelection(query);
                    }
                }
            });
        }


    const providerInput = document.getElementById('provider-code-input');
    const providerNameDisplay = document.getElementById('provider-name-display');
    const searchBtn = document.getElementById('btn-search-provider');
    const loadBtn = document.getElementById('btn-load-products');
    const formContainer = document.getElementById('provider-selection-form');
    const tableContainer = document.getElementById('products-table-container');
    const tableBody = document.getElementById('products-table-body');
    const changeProviderBtn = document.getElementById('btn-change-provider');
    const selectedProviderLabel = document.getElementById('selected-provider-label');
    const providerDetailsEl = document.getElementById('provider-details');
    const loadingIndicator = document.getElementById('loading-indicator');
    let storeCheckboxes = document.querySelectorAll('.store-checkbox');
    let currentItems = null;
    // Selección de productos
    const selectedIndices = new Set();

    let selectedProvider = null;

    // Open Modal provider search
    searchBtn.addEventListener('click', () => {
        if (typeof openProviderModal === 'function') {
            openProviderModal((provider) => {
                selectedProvider = provider;
                providerInput.value = provider.provider_code;
                providerNameDisplay.value = provider.provider_name;
                loadBtn.disabled = false;
                // Cargar detalles del proveedor seleccionado
                const code = selectedProvider?.provider_code || selectedProvider?.code;
                if (code) {
                    fetchProviderDetails(code).then(p => {
                        if (p) renderProviderDetails(p);
                    });
                }
            });
        } else {
            console.error('openProviderModal not found');
        }
    });

    // Utilidad: obtener depósitos seleccionados
    function getSelectedStores() {
        return Array.from(storeCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
    }

    // Utilidad: obtener unidad principal (main_unit) del producto
    function getDefaultUnit(item) {
        try {
            if (item && Array.isArray(item.units)) {
                const main = item.units.find(u => u.main_unit === true || u.main_unit === 't' || u.main_unit === 1);
                if (main) {
                    return main.unit_description || main.description || main.unit || main.unit_name || '';
                }
            }
            return item.unit_description || '';
        } catch (e) {
            return item && item.unit_description ? item.unit_description : '';
        }
    }

    // Load Products
    loadBtn.addEventListener('click', async () => {
        if (!selectedProvider) return;

        // Show loading, disable button
        loadBtn.disabled = true;
        loadingIndicator.classList.remove('hidden');

        // Fetch data
        try {
            const response = await fetch(`/shopping/api/products/history/${encodeURIComponent(selectedProvider.provider_code)}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            console.log('Fetched data:', data);

            if (data.ok) {
                // Hide form, show table
                formContainer.classList.add('hidden');
                tableContainer.classList.remove('hidden');
                selectedProviderLabel.textContent = `Proveedor: ${selectedProvider.provider_name} (${selectedProvider.provider_code})`;
                // Asegurar detalles del proveedor
                const code = selectedProvider?.provider_code || selectedProvider?.code;
                if (code) {
                    fetchProviderDetails(code).then(p => {
                        if (p) renderProviderDetails(p);
                    });
                }
                // Actualizar referencia a checkboxes (por si el DOM cambió)
                storeCheckboxes = document.querySelectorAll('.store-checkbox');
                // Guardar items para re-render en cambios de depósito
                currentItems = data.items;
                // Re-render con datos y depósitos seleccionados
                renderTable(currentItems);
                // Re-adjuntar listeners en los checkboxes (por seguridad)
                storeCheckboxes.forEach(cb => {
                    cb.addEventListener('change', () => {
                        if (currentItems) {
                            renderTable(currentItems);
                        }
                    });
                });
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error fetching history:', error);
            alert('Error de conexión al buscar productos.');
        } finally {
            loadBtn.disabled = false;
            loadingIndicator.classList.add('hidden');
        }
    });

    // Change Provider (Reset)
    changeProviderBtn.addEventListener('click', () => {
        tableContainer.classList.add('hidden');
        formContainer.classList.remove('hidden');
        tableBody.innerHTML = '';
    });

    function renderTable(items) {
        if (!items || items.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">No se encontraron productos previos para este proveedor.</td></tr>';
            return;
        }
        const selectedStores = getSelectedStores();

        tableBody.innerHTML = items.map(item => {
            // Sumar existencia mínima y máxima por depósitos seleccionados
            let minStock = 0;
            let maxStock = 0;
            let currentStock = 0;

            // Datos de mínimos/máximos suelen venir de products_failures en item.parameters
            if (item.parameters && Array.isArray(item.parameters)) {
                item.parameters.forEach(p => {
                    const storeId = p.store_Code || p.store_code || p.store;
                    if (!storeId) return;
                    // Sumar SOLO los depósitos seleccionados
                    if (selectedStores.includes(String(storeId))) {
                        minStock += Number(p.minimal_stock || 0);
                        maxStock += Number(p.maximum_stock || 0);
                    }
                });
            }

            // Existencia actual viene de item.stocks: [{ store, stock }]
            if (item.stocks && Array.isArray(item.stocks)) {
                item.stocks.forEach(s => {
                    const storeId = s.store || s.store_code || s.store_Code;
                    if (!storeId) return;
                    // Sumar SOLO los depósitos seleccionados
                    if (selectedStores.includes(String(storeId))) {
                        currentStock += Number(s.stock || 0);
                    }
                });
            }
            let indexedItem = items.indexOf(item); // ubicaicon de item en el array
            const suggestedQuantity = Math.max(0, Number(maxStock) - Number(currentStock));
            return `
            <tr class="hover:bg-gray-50 ${item.highlight ? 'bg-yellow-50' : ''}">
                <td class="px-4 py-3 text-center"><input type="checkbox" class="select-product" value="${item.product_code}" data-index="${indexedItem}" ${selectedIndices.has(indexedItem) ? 'checked' : ''}></td>
                <td class="px-4 py-3 font-medium text-gray-900">${item.product_code}</td>
                <td class="px-4 py-3">${item.product_description}</td>
                <td class="px-4 py-3">${item.department_description || item.product_department || ''}</td>
                <td class="px-4 py-3">${getDefaultUnit(item)}</td>
                <td class="px-4 py-3">${item.product_provider_emission_date || ''}</td>
                <td class="px-4 py-3 text-center">${minStock}</td>
                <td class="px-4 py-3 text-center">${maxStock}</td>
                <td class="px-4 py-3 text-center">${currentStock}</td>
                <td class="px-4 py-3 text-right">${item.product_provider_unitary_cost != null ? Number(item.product_provider_unitary_cost).toFixed(2) : ''}</td>
                <td class="px-4 py-3 text-center">${item.product_provider_document_no || ''}</td>
                <td class="px-4 py-3 text-center font-bold text-blue-600">
                <input type="number" value="${suggestedQuantity}" min="0" class="w-20 border rounded px-2 py-1 text-sm" data-index="${indexedItem}">
                    
                    </td>
            </tr>`;
        }).join('');
        attachRowSelectionHandlers();
    }

    // Re-render al cambiar selección de depósitos
    storeCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            if (currentItems) {
                renderTable(currentItems);
            }
        });
    });

    function attachRowSelectionHandlers() {
        const rowCbs = document.querySelectorAll('.select-product');
        rowCbs.forEach(cb => {
            cb.addEventListener('change', () => {
                const idx = Number(cb.dataset.index);
                if (cb.checked) {
                    selectedIndices.add(idx);
                } else {
                    selectedIndices.delete(idx);
                }
            });
        });
        const selectAllCb = document.getElementById('select-all-products');
        if (selectAllCb) {
            selectAllCb.checked = rowCbs.length > 0 && Array.from(rowCbs).every(cb => cb.checked);
            selectAllCb.onclick = () => {
                const check = selectAllCb.checked;
                rowCbs.forEach(cb => {
                    cb.checked = check;
                    const idx = Number(cb.dataset.index);
                    if (check) selectedIndices.add(idx);
                    else selectedIndices.delete(idx);
                });
            };
        }
    }

    async function fetchProviderDetails(code) {
        try {
            const response = await fetch(`/shopping/api/providers/details/${encodeURIComponent(code)}`);
            if (!response.ok) throw new Error('No se pudo obtener la información del proveedor');
            const data = await response.json();
            return data.provider || null;
        } catch (error) {
            console.error('Error fetching provider:', error);
            if (providerDetailsEl) providerDetailsEl.textContent = 'Detalles: error al cargar';
            return null;
        }
    }

    function renderProviderDetails(provider) {
        if (!providerDetailsEl || !provider) return;
        const rif = provider.provider_id || provider.rif || '---';
        const tel = provider.provider_phone || provider.phone || '---';
        const dir = provider.address || provider.provider_address || '---';
        providerDetailsEl.textContent = `Detalles: RIF ${rif} | Tel ${tel} | ${dir}`;
    }
</script>
{% endblock %}