{% extends 'base.html' %}

{% block title %}Orden de Compra Automatica{% endblock %}
{% block content %}
<div id="auto-order-page" class="w-full p-4">
    <h1 class="text-2xl font-semibold mb-4 text-gray-800">Orden de Compra Automática</h1>
    <!-- Provider Selection Form -->
    <div id="provider-selection-form"
        class="bg-white p-6 rounded-lg shadow-md border border-gray-200 max-w-2xl mx-auto">
        <h2 id="provider-selection-title" class="text-lg font-semibold mb-4 text-gray-700">Seleccionar Proveedor</h2>
        <div class="flex gap-4 items-end">
            <div class="flex-1">
                <label for="provider-code-input" class="block text-sm font-medium text-gray-700 mb-1">Código de
                    Proveedor</label>
                <div class="flex gap-2">
                    <input type="text" id="provider-code-input"
                        class="flex-1 border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Ingrese código o busque...">
                    <button id="btn-search-provider"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Buscar
                    </button>
                </div>
            </div>
        </div>
        <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Proveedor</label>
            <input type="text" id="provider-name-display"
                class="w-full border rounded px-3 py-2 text-sm bg-gray-50 text-gray-600" readonly placeholder="---">
        </div>

        <div class="mt-6 flex justify-end">
            <button id="btn-load-products" disabled
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Cargar Productos
            </button>
        </div>


        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden mt-6">
            <div class="relative w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div class="absolute top-0 h-4 bg-blue-600 rounded-full progress-bar-value"></div>
            </div>
            <p class="text-center text-sm font-medium text-gray-600 mt-2 animate-pulse">Buscando productos, por favor
                espere...</p>
        </div>
    </div>

    <style>
        @keyframes indeterminate {
            0% {
                left: -35%;
                width: 35%;
            }

            60% {
                left: 100%;
                width: 10%;
            }

            100% {
                left: 100%;
                width: 10%;
            }
        }

        .progress-bar-value {
            animation: indeterminate 1.5s infinite linear;
        }

        /* Estilo para resaltar errores en cantidad */
        .purchase-qty-input.qty-error {
            border-color: #fca5a5;
            /* Rojo suave constante para que se note algo */
            transition: all 0.2s ease;
        }

        .purchase-qty-input.qty-error:hover,
        .purchase-qty-input.qty-error:focus {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
            outline: none;
        }
    </style>

    <!-- Products Table (Hidden initially) -->
    <div id="products-table-container" class="hidden mt-6 bg-white rounded-lg shadow border border-gray-200">
        <div id="products-top-panels" class="p-4 border-b bg-gray-50 rounded-t-lg grid grid-cols-3 gap-4 items-stretch">
            <div id="section-provider" class="col-span-1">
                <div class="bg-white rounded-lg shadow p-3 border border-gray-200 flex flex-col" style="height: 160px;">
                    <div class="flex items-center justify-between border-b pb-1 mb-2">
                        <h2 id="provider-data-title" class="text-base font-semibo    |||||||||||||||ld text-gray-700">
                            Datos del Proveedor</h2>
                        <button id="btn-change-provider"
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium px-2 py-1 border border-blue-200 rounded">
                            Cambiar Proveedor
                        </button>
                    </div>
                    <div id="provider-info" class="space-y-2 text-xs flex-1 overflow-y-auto">
                        <p id="selected-provider-label" class="text-sm text-gray-500">Proveedor: ---</p>
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                            <span class="text-gray-500">Días Crédito:</span>
                            <input type="number" id="input-provider-credit-days"
                                class="w-16 border rounded px-1 py-0.5 text-right text-xs focus:ring-2 focus:ring-blue-500 outline-none"
                                value="{{ provider.credit_days if provider else 0 }}" min="0">
                        </div>
                        <div id="coins" class="flex justify-between items-center border-b border-gray-100 pb-1">
                            <span class="text-gray-500">Moneda:</span>
                            <select id="select-coin"
                                class="w-32 border rounded px-1 py-0.5 text-xs focus:ring-2 focus:ring-blue-500 outline-none">
                                {% for coin in coins %}
                                <option value="{{ coin.code }}" {% if coin.code==default_coin %}selected{% endif %}>{{
                                    coin.description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="section-stores" class="col-span-1">
                <div class="bg-white rounded-lg shadow p-3 border border-gray-200 flex flex-col" style="height: 160px;">
                    <h2 id="stores-title" class="text-base font-semibold mb-2 text-gray-700 border-b pb-1">Selecciona
                        Depósitos</h2>
                    <div class="space-y-2 text-xs flex-1 overflow-y-auto">
                        {% if stores %}
                        {% for store in stores %}
                        <label class="flex items-center">
                            <input type="checkbox" value="{{ store.code }}" class="store-checkbox mr-2" checked>
                            {{ store.description }}
                        </label>
                        {% endfor %}
                        {% else %}
                        <p class="text-xs text-gray-500">No hay depósitos disponibles.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div id="section-purchase-total" class="col-span-1">
                <div class="bg-white rounded-lg shadow p-3 border border-gray-200 flex flex-col" style="height: 160px;">
                    <h2 id="purchase-total-title" class="text-base font-semibold mb-2 text-gray-700 border-b pb-1">Total
                        de la compra</h2>
                    <div class="flex items-end gap-2 mt-auto">
                        <span class="text-xs text-gray-500">Monto total:</span>
                        <span id="top-total-purchase-amount" class="text-lg font-bold text-green-700">0.00</span>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button id="btn-open-summary-modal"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                            Ver detalles de Compras
                        </button>
                        <button id="btn-save-order"
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-xs font-medium">
                            Guardar pedido
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="table-scroll-container" class="relative overflow-x-auto max-h-[65vh] overflow-y-auto">

            <!-- Barra de filtros de tabla (departamentos, marcas y buscador) -->

            <div id="table-filters"
                class="px-4 py-2 bg-white border-t border-b border-gray-200 hidden sticky top-0 z-20">
                <div class="flex items-center gap-3 flex-wrap">
                    <!-- Dropdown Departamentos -->
                    <div class="relative" id="dept-dropdown">
                        <button type="button"
                            class="px-3 py-1 border rounded text-sm bg-white hover:bg-gray-50 flex items-center gap-1"
                            id="dept-toggle" aria-haspopup="true" aria-expanded="false">
                            <span class="font-medium">Departamentos</span>
                            <span id="dept-selected-summary" class="text-xs text-gray-500">Todos</span>
                            <svg width="14" height="14" fill="currentColor" class="text-gray-500" aria-hidden="true">
                                <path d="M7 10l5-5H2z"></path>
                            </svg>
                        </button>
                        <div id="dept-panel"
                            class="absolute mt-1 left-0 w-56 max-h-64 overflow-y-auto bg-white border border-gray-200 rounded shadow-lg z-50 hidden p-2 space-y-2">
                            <div class="flex items-center justify-between">
                                <label class="inline-flex items-center gap-2 text-sm">
                                    <input type="checkbox" id="dept-all" class="mr-1">
                                    <span>Todos</span>
                                </label>
                                <button type="button" id="dept-clear" class="text-xs text-blue-600">Limpiar</button>
                            </div>
                            <div class="space-y-1" id="dept-options"></div>
                        </div>
                    </div>

                    <!-- Dropdown Marcas -->
                    <div class="relative" id="brand-dropdown">
                        <button type="button"
                            class="px-3 py-1 border rounded text-sm bg-white hover:bg-gray-50 flex items-center gap-1"
                            id="brand-toggle" aria-haspopup="true" aria-expanded="false">
                            <span class="font-medium">Marcas</span>
                            <span id="brand-selected-summary" class="text-xs text-gray-500">Todas</span>
                            <svg width="14" height="14" fill="currentColor" class="text-gray-500" aria-hidden="true">
                                <path d="M7 10l5-5H2z"></path>
                            </svg>
                        </button>
                        <div id="brand-panel"
                            class="absolute mt-1 left-0 w-56 max-h-64 overflow-y-auto bg-white border border-gray-200 rounded shadow-lg z-50 hidden p-2 space-y-2">
                            <div class="flex items-center justify-between">
                                <label class="inline-flex items-center gap-2 text-sm">
                                    <input type="checkbox" id="brand-all" class="mr-1">
                                    <span>Todas</span>
                                </label>
                                <button type="button" id="brand-clear" class="text-xs text-blue-600">Limpiar</button>
                            </div>
                            <div class="space-y-1" id="brand-options"></div>
                        </div>
                    </div>

                    <!-- Buscador de producto en tabla -->
                    <div>
                        <label for="table-product-search" class="text-sm font-medium text-gray-700">Buscar
                            producto</label>
                        <input id="table-product-search" type="search" placeholder="Buscar por código o descripción..."
                            class="border rounded px-2 py-1 text-sm w-64" />
                    </div>
                    <div>
                        <label for="input-search-product" class="text-sm font-medium text-gray-700">Agregar
                            Producto</label>
                        <input id="input-search-product" type="search" placeholder="agregar producto por codigo"
                            class="border rounded px-2 py-1 text-sm w-64" />
                        <button id="button-search-product"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-medium">
                            Buscar
                        </button>
                    </div>
                    <div id="products-count" class="flex items-center gap-4 ml-4">
                        <span class="text-xs text-gray-500">Productos mostrados: <span
                                id="displayed-products-count">0</span></span>
                        <span class="text-xs text-gray-700">Productos seleccionados: <span
                                id="selected-products-count">0</span></span>
                    </div>
                </div>
            </div>
            <table id="products-table" class="w-full text-sm text-left">
                <colgroup>
                    <col>
                    <col style="width: 35%">
                    <col>
                    <col>
                    <col>
                    <col class="fecha-col">
                    <col>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col style="width: 8rem">
                    <col style="width: 8rem">
                    <col>
                    <col>
                </colgroup>
                <thead id="table-header" class="bg-gray-100 text-gray-600 font-medium border-b sticky z-10">
                    <tr>
                        <th class="px-4 py-3 text-center"><input type="checkbox" id="select-all-products"
                                title="Seleccionar todos"></th>
                        <th class="px-4 py-3">Producto</th>
                        <th class="px-4 py-3">Marca</th>
                        <th class="px-4 py-3">Departamento</th>
                        <th class="px-4 py-3">Unidad</th>
                        <th class="px-4 py-3 fecha-cell">Ultima Compra</th>
                        <th class="px-4 py-3">Existencia Minima</th>
                        <th class="px-4 py-3">Existencia Maxima</th>
                        <th class="px-4 py-3">Existencia actual</th>
                        <th class="px-4 py-3 text-right">Último Costo</th>
                        <th class="px-4 py-3 text-center">Última Compra</th>
                        <th class="px-4 py-3 text-center">Cantidad a comprar</th>
                        <th class="px-4 py-3 text-center">Costo de compra</th>
                        <th class="px-4 py-3 text-right">Subtotal</th>
                        <th class="px-4 py-3 text-center">Producto en espera</th>
                        <th class="px-4 py-3 text-center">Opciones</th>

                    </tr>
                </thead>
                <tbody id="products-table-body" class="divide-y divide-gray-100">
                    <!-- Rows will be populated by JS -->
                </tbody>
            </table>
        </div>
        <!-- Purchase Summary Section -->
        <div id="purchase-summary-container" class="mt-4 bg-white rounded-lg shadow border border-gray-200 hidden">
            <div id="shopping-detail" class="p-4 border-b bg-gray-50 rounded-t-lg flex items-center justify-between">
                <h2 id="purchase-summary-panel-title" class="text-base font-semibold text-gray-700">Detalle de la compra
                </h2>
                <div class="flex gap-6 text-sm">
                    <span class="text-gray-700">Productos seleccionados: <strong
                            id="total-selected-products-count">0</strong></span>
                    <span class="text-gray-700">Cantidad total: <strong id="total-selected-quantity">0</strong></span>
                    <span class="text-gray-700">Total de la compra: <strong
                            id="total-purchase-amount">0.00</strong></span>
                </div>
            </div>
            <div class="p-4 overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <colgroup>
                        <col style="width: 18%">
                        <col>
                        <col style="width: 10%">
                        <col style="width: 12%">
                        <col style="width: 12%">
                        <col style="width: 12%">
                    </colgroup>
                    <thead class="bg-gray-100 text-gray-600 font-medium border-b">
                        <tr>
                            <th class="px-4 py-2">Código</th>
                            <th class="px-4 py-2">Descripción</th>
                            <th class="px-4 py-2 text-center">Unidad</th>
                            <th class="px-4 py-2 text-right">Cantidad</th>
                            <th class="px-4 py-2 text-right">Costo</th>
                            <th class="px-4 py-2 text-right">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="selected-products-table-body" class="divide-y divide-gray-100">
                        <!-- Se rellena dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Product Detail Modal -->
<div id="product-detail-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center"
    style="background-color: rgba(0,0,0,0.18);">
    <div id="product-detail-dialog" class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4" role="dialog"
        aria-modal="true" aria-labelledby="product-detail-title">
        <div class="flex items-center justify-between p-3 border-b">
            <h3 id="product-detail-title" class="text-base font-semibold text-gray-800">Detalle de producto</h3>
            <button id="product-detail-close" class="text-gray-500 hover:text-gray-700 p-2" aria-label="Cerrar">
                <span class="text-2xl leading-none">&times;</span>
            </button>
        </div>
        <!-- Contenedor de pestañas -->
        <div class="px-4 pt-3">
            <div id="product-detail-tabs" class="flex gap-4 border-b">
                <button type="button"
                    class="tab-link px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 border-b-2 border-transparent"
                    data-tab="general" aria-controls="product-detail-tab-general" aria-selected="true">General</button>
                <button type="button"
                    class="tab-link px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 border-b-2 border-transparent"
                    data-tab="parametros" aria-controls="product-detail-tab-parametros"
                    aria-selected="false">Parametros</button>
            </div>
        </div>
        <!-- Paneles de contenido de pestañas -->
        <div id="product-detail-content" class="p-6">
            <div id="product-detail-tab-general" class="tab-panel space-y-6">
                <div id="product-detail-tab-general-content">
                    <!-- Sección Descripción -->
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-900 mb-4 border-b pb-2">Descripción del Producto</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="product-code" class="block text-xs font-medium text-gray-500 mb-1">Código</label>
                                <input type="text" id="product-code" name="product-code" value="" disabled
                                    class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                            <div class="md:col-span-2">
                                <label for="product-description" class="block text-xs font-medium text-gray-500 mb-1">Nombre</label>
                                <input type="text" id="product-description" name="product-description" value=""
                                    class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                        </div>
                    </div>

                    <!-- Sección Precios -->
                    <div>
                        <h4 class="text-sm font-semibold text-gray-900 mb-4 border-b pb-2">Lista de Precios</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="maximum-price" class="block text-xs font-medium text-gray-500 mb-1">Precio Máximo</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">$</span>
                                    </div>
                                    <input type="number" id="maximum-price" name="maximum-price" value=""
                                        class="pl-7 w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 text-right">
                                </div>
                            </div>
                            <div>
                                <label for="offer-price" class="block text-xs font-medium text-gray-500 mb-1">Precio Oferta</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">$</span>
                                    </div>
                                    <input type="number" id="offer-price" name="offer-price" value=""
                                        class="pl-7 w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 text-right">
                                </div>
                            </div>
                            <div>
                                <label for="higher-price" class="block text-xs font-medium text-gray-500 mb-1">Precio Mayor</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">$</span>
                                    </div>
                                    <input type="number" id="higher-price" name="higher-price" value=""
                                        class="pl-7 w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 text-right">
                                </div>
                            </div>
                            <div>
                                <label for="minimum-price" class="block text-xs font-medium text-gray-500 mb-1">Precio Mínimo</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">$</span>
                                    </div>
                                    <input type="number" id="minimum-price" name="minimum-price" value=""
                                        class="pl-7 w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 text-right">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="product-detail-tab-parametros" class="tab-panel hidden">
                <div id="product-detail-tab-parametros-content">
                    <h4 class="text-sm font-semibold text-gray-900 mb-4 border-b pb-2">Parámetros por Depósito</h4>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Ejemplo de tarjeta de depósito -->
                        <div class="bg-gray-50 rounded-lg border border-gray-200 p-4">
                            <h5 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Depósito Principal
                            </h5>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Stock Máximo</label>
                                    <input type="number" class="w-full bg-white border border-gray-300 text-gray-900 text-xs rounded focus:ring-blue-500 focus:border-blue-500 block p-2 text-center" value="100">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Stock Mínimo</label>
                                    <input type="number" class="w-full bg-white border border-gray-300 text-gray-900 text-xs rounded focus:ring-blue-500 focus:border-blue-500 block p-2 text-center" value="10">
                                </div>
                            </div>
                        </div>

                        <!-- Repetir para otros depósitos (ejemplo estático) -->
                        <div class="bg-gray-50 rounded-lg border border-gray-200 p-4">
                            <h5 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Depósito Secundario
                            </h5>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Stock Máximo</label>
                                    <input type="number" class="w-full bg-white border border-gray-300 text-gray-900 text-xs rounded focus:ring-blue-500 focus:border-blue-500 block p-2 text-center" value="50">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Stock Mínimo</label>
                                    <input type="number" class="w-full bg-white border border-gray-300 text-gray-900 text-xs rounded focus:ring-blue-500 focus:border-blue-500 block p-2 text-center" value="5">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Purchase Summary Modal -->
<div id="purchase-summary-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center"
    style="background-color: rgba(0,0,0,0.18);">
    <div id="purchase-summary-dialog" class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4" role="dialog"
        aria-modal="true" aria-labelledby="purchase-summary-title"
        style="max-height: 80vh; display: flex; flex-direction: column;">
        <div class="flex items-center justify-between p-3 border-b">
            <h3 id="purchase-summary-title" class="text-base font-semibold text-gray-800">Detalle de la compra</h3>
            <button id="purchase-summary-close" class="text-gray-500 hover:text-gray-700 p-2" aria-label="Cerrar">
                <span class="text-2xl leading-none">&times;</span>
            </button>
        </div>
        <div id="purchase-summary-content" class="p-4" style="overflow-y: auto;">
            <!-- Contenido del detalle de compra se insertará aquí -->
        </div>
    </div>
</div>

<!-- Include Provider Search Modal -->
{% include 'partials/browser_providers.html' %}
<!-- Include Product Search Modal -->
{% include 'partials/bowser_products.html' %}


<script>


    // Handler mínimo para selección de producto desde el modal
    function handleProductSelection(code) {
        try {
            if (!code) return;
            console.log('Producto seleccionado desde modal:', code);

            if (!selectedProvider || !selectedProvider.provider_code) {
                alert('Por favor, seleccione un proveedor antes de buscar productos.');
                return;
            }

            // Fetch al endpoint para obtener el producto con el mismo shape que los demás
            // Usamos query param para el proveedor para evitar problemas con caracteres especiales en la URL
            const url = `/shopping/api/products/history_by_code/${encodeURIComponent(code)}?provider_code=${encodeURIComponent(selectedProvider.provider_code)}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data || !data.ok || !data.item) {
                        alert(data && data.error ? data.error : 'Producto no encontrado');
                        return;
                    }
                    const newItem = data.item[0];
                    console.log("Producto obtenido:", newItem);
                    // Marcar para resaltar en la tabla
                    newItem.highlight = true;
                    // Inicializar items si no existen
                    if (!Array.isArray(currentItems)) {
                        currentItems = [];
                    }
                    // Insertar al inicio y re-renderizar
                    currentItems = [newItem, ...(Array.isArray(currentItems) ? currentItems : [])];
                    renderTable(currentItems);
                    initFilters(currentItems);
                    try { filterRows(); } catch (e) { }
                })
                .catch(err => {
                    console.error('Error obteniendo producto por código:', err);
                    alert('Error al obtener el producto.');
                });
        } catch (e) {
            console.error('Error en handleProductSelection:', e);
        }
    }

    // Cálculo de subtotal por fila
    function updateRowSubtotal(idx) {
        try {
            const qtyInput = document.querySelector(`.purchase-qty-input[data-index="${idx}"]`);
            const costInput = document.querySelector(`.purchase-cost-input[data-index="${idx}"]`);
            const cell = document.querySelector(`.subtotal-cell[data-index="${idx}"]`);
            if (!cell) return;
            const qty = qtyInput ? Number(qtyInput.value) : 0;
            const cost = costInput ? Number(costInput.value) : 0;
            const subtotal = (isFinite(qty) ? qty : 0) * (isFinite(cost) ? cost : 0);
            cell.textContent = Number(subtotal).toFixed(2);
        } catch (e) { }
    }

    // Forzar valores no negativos en inputs numéricos
    function sanitizeNonNegative(inputEl) {
        try {
            const v = Number(inputEl && inputEl.value);
            if (!isFinite(v) || v < 0) {
                inputEl.value = '0';
            }
        } catch (e) { }
    }

    // Product Search Button Handler
    const btnProduct = document.getElementById('button-search-product');
    if (btnProduct) {
        btnProduct.addEventListener('click', function (e) {
            e.preventDefault();
            console.log('Click en buscar producto');
            if (typeof openProductSearchModal === 'function') {
                console.log('Abriendo modal de productos...');
                openProductSearchModal(handleProductSelection);
            } else {
                console.error('openProductSearchModal no está definida');
                alert('Error: La función para abrir el modal no está cargada.');
            }
        });
    } else {
        console.error('Button button-search-product not found');
    }

    // Input Enter Key Handler
    const inputProduct = document.getElementById('input-search-product');
    if (inputProduct) {
        inputProduct.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = this.value.trim();
                if (query) {
                    handleProductSelection(query);
                }
            }
        });
    }


    const providerInput = document.getElementById('provider-code-input');
    const providerNameDisplay = document.getElementById('provider-name-display');
    const searchBtn = document.getElementById('btn-search-provider');
    const loadBtn = document.getElementById('btn-load-products');
    const formContainer = document.getElementById('provider-selection-form');
    const tableContainer = document.getElementById('products-table-container');
    const tableBody = document.getElementById('products-table-body');
    const changeProviderBtn = document.getElementById('btn-change-provider');
    const selectedProviderLabel = document.getElementById('selected-provider-label');
    const providerDetailsEl = document.getElementById('provider-details');
    const loadingIndicator = document.getElementById('loading-indicator');
    let storeCheckboxes = document.querySelectorAll('.store-checkbox');
    let currentItems = null;
    // Selección de productos
    const selectedIndices = new Set();

    // Detalles del proveedor seleccionados (para guardar la orden)
    let selectedProviderDetails = null;

    let selectedProvider = null;

    // Delegado: abrir modal al hacer clic en el nombre del producto o en "Ver Detalles"
    if (tableBody) {
        tableBody.addEventListener('click', async function (e) {
            const target = e.target;
            if (target && target.classList && target.classList.contains('product-detail-link')) {
                e.preventDefault();
                try {
                    const code = target.getAttribute('data-code');
                    if (!code) return;
                    if (!selectedProvider || !selectedProvider.provider_code) {
                        alert('Seleccione un proveedor antes de ver el detalle del producto.');
                        return;
                    }
                    const product = await fetchProductHistoryByCode(code, selectedProvider.provider_code);
                    console.log('Producto obtenido para modal:', product);
                    // Renderizar en el modal y abrirlo
                    renderProductDetailInModal(product);
                    if (typeof openProductDetailModal === 'function') {
                        openProductDetailModal('');
                    }
                } catch (err) {
                    console.error('Error al obtener el producto:', err);
                    alert('No se pudo obtener el detalle del producto.');
                }
            } else if (target && target.classList && target.classList.contains('order-details-link')) {
                e.preventDefault();
                const idx = Number(target.getAttribute('data-index'));
                if (!Number.isFinite(idx) || !Array.isArray(currentItems)) return;
                const item = currentItems[idx];
                const orders = (item && Array.isArray(item.product_in_order)) ? item.product_in_order : [];
                const html = buildOrderDetailsHtml(orders);
                if (typeof openProductDetailModal === 'function') {
                    openProductDetailModal(html);
                }
            }
        });
    }

    // Función reutilizable: obtener historial del producto por código
    async function fetchProductHistoryByCode(productCode, providerCode) {
        const url = `/shopping/api/products/history_by_code/${encodeURIComponent(productCode)}?provider_code=${encodeURIComponent(providerCode || '')}`;
        const res = await fetch(url);
        const data = await res.json();
        console.log('Respuesta API producto por código:', data);
        if (!data || !data.ok || !data.item) {
            throw new Error(data && data.error ? data.error : 'Producto no encontrado');
        }
        return data.item;
    }
    // Exponer opcionalmente para reutilizar desde otros scripts
    window.fetchProductHistoryByCode = fetchProductHistoryByCode;

    // Función reutilizable: renderizar el producto en el modal (pestaña General)
    function renderProductDetailInModal(item) {
        try {
            const codeEl = document.getElementById('product-code');
            const descEl = document.getElementById('product-description');
            const maxEl = document.getElementById('maximum-price');
            const offerEl = document.getElementById('offer-price');
            const higherEl = document.getElementById('higher-price');
            const minEl = document.getElementById('minimum-price');

            const code = item.product_code || item.code || '';
            const description = item.product_description || item.description || '';
            if (codeEl) codeEl.value = code;
            if (descEl) descEl.value = description;

            // Seleccionar unidad principal si existe
            const units = Array.isArray(item.units) ? item.units : [];
            const mainUnit = units.find(u => u && (u.main_unit === true || u.main_unit === 't' || u.main_unit === 1)) || units[0] || {};
            const getNum = (v) => (v != null && v !== '' && isFinite(Number(v))) ? Number(v).toFixed(2) : '';
            const maximum = mainUnit.maximum_price ?? item.maximum_price;
            const offer = mainUnit.offer_price ?? item.offer_price;
            const higher = mainUnit.higher_price ?? item.higher_price;
            const minimum = mainUnit.minimum_price ?? item.minimum_price;

            if (maxEl) maxEl.value = getNum(maximum);
            if (offerEl) offerEl.value = getNum(offer);
            if (higherEl) higherEl.value = getNum(higher);
            if (minEl) minEl.value = getNum(minimum);
        } catch (e) {
            console.error('Error renderizando producto en modal:', e);
        }
    }
    window.renderProductDetailInModal = renderProductDetailInModal;

    function buildOrderDetailsHtml(orders) {
        try {
            if (!Array.isArray(orders) || orders.length === 0) {
                return '<div class="p-4 text-sm text-gray-600">Sin compras reportadas con otros proveedores.</div>';
            }
            const rows = orders.map(o => `
                <tr class="border-b">
                    <td class="px-2 py-1">${o.document_no || ''}</td>
                    <td class="px-2 py-1">${o.emission_date || ''}</td>
                    <td class="px-2 py-1">${o.provider_name || ''}</td>
                    <td class="px-2 py-1 text-right">${o.unitary_cost != null ? Number(o.unitary_cost).toFixed(2) : ''}</td>
                    <td class="px-2 py-1 text-right">${o.amount != null ? Number(o.amount) : ''}</td>
                </tr>
            `).join('');
            return `
                <div class="p-2">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-700">
                            <tr>
                                <th class="px-2 py-1">Documento</th>
                                <th class="px-2 py-1">Fecha</th>
                                <th class="px-2 py-1">Proveedor</th>
                                <th class="px-2 py-1 text-right">Costo Unitario</th>
                                <th class="px-2 py-1 text-right">Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        } catch (e) {
            return '<div class="p-4 text-sm text-red-600">Error al construir detalles.</div>';
        }
    }

    // Open Modal provider search
    searchBtn.addEventListener('click', () => {
        if (typeof openProviderModal === 'function') {
            openProviderModal((provider) => {
                selectedProvider = provider;
                selectedIndices.clear();
                providerInput.value = provider.provider_code;
                providerNameDisplay.value = provider.provider_name;
                loadBtn.disabled = false;
                // Cargar detalles del proveedor seleccionado
                const code = selectedProvider?.provider_code || selectedProvider?.code;
                if (code) {
                    fetchProviderDetails(code).then(p => {
                        if (p) renderProviderDetails(p);
                    });
                }
            });
        } else {
            console.error('openProviderModal not found');
        }
    });

    // Utilidad: obtener depósitos seleccionados
    function getSelectedStores() {
        return Array.from(storeCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
    }

    // Utilidad: obtener unidad principal (main_unit) del producto
    function getDefaultUnit(item) {
        try {
            if (item && Array.isArray(item.units)) {
                const main = item.units.find(u => u.main_unit === true || u.main_unit === 't' || u.main_unit === 1);
                if (main) {
                    return main.unit_description || main.description || main.unit || main.unit_name || '';
                }
            }
            return item.unit_description || '';
        } catch (e) {
            return item && item.unit_description ? item.unit_description : '';
        }
    }

    // devuelve el historico de un producto
    async function getHistoryProductByCode(productCode) {
        return await fetch(`/shopping/api/products/history_by_code/${encodeURIComponent(productCode)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(res => res.json());
    }




    // Load Products
    loadBtn.addEventListener('click', async () => {
        if (!selectedProvider) return;

        // Show loading, disable button
        loadBtn.disabled = true;
        loadingIndicator.classList.remove('hidden');

        // Fetch data
        try {
            const response = await fetch(`/shopping/api/products/history/${encodeURIComponent(selectedProvider.provider_code)}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            console.log('Fetched data:', data);

            if (data.ok) {
                // Hide form, show table
                formContainer.classList.add('hidden');
                tableContainer.classList.remove('hidden');
                selectedProviderLabel.textContent = `Proveedor: ${selectedProvider.provider_name} (${selectedProvider.provider_code})`;
                // Asegurar detalles del proveedor
                const code = selectedProvider?.provider_code || selectedProvider?.code;
                if (code) {
                    fetchProviderDetails(code).then(p => {
                        if (p) renderProviderDetails(p);
                    });
                }
                // Actualizar referencia a checkboxes (por si el DOM cambió)
                storeCheckboxes = document.querySelectorAll('.store-checkbox');
                // Guardar items para re-render en cambios de depósito
                currentItems = data.items;
                // Re-render con datos y depósitos seleccionados
                renderTable(currentItems);
                // Inicializar filtros con los datos cargados
                initFilters(currentItems);
                // Re-adjuntar listeners en los checkboxes (por seguridad)
                storeCheckboxes.forEach(cb => {
                    cb.addEventListener('change', () => {
                        if (currentItems) {
                            renderTable(currentItems);
                            try { filterRows(); } catch (e) { }
                        }
                    });
                });
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error fetching history:', error);
            alert('Error de conexión al buscar productos.');
        } finally {
            loadBtn.disabled = false;
            loadingIndicator.classList.add('hidden');
        }
    });

    // Change Provider (Reset)
    changeProviderBtn.addEventListener('click', () => {
        tableContainer.classList.add('hidden');
        formContainer.classList.remove('hidden');
        tableBody.innerHTML = '';
    });

    function renderTable(items) {
        if (!items || items.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">No se encontraron productos previos para este proveedor.</td></tr>';
            return;
        }
        const selectedStores = getSelectedStores();

        // 1. Calcular stock actual para cada item y guardarlo temporalmente
        items.forEach(item => {
            let currentStock = 0;
            if (item.stocks && Array.isArray(item.stocks)) {
                item.stocks.forEach(s => {
                    const storeId = s.store || s.store_code || s.store_Code;
                    if (!storeId) return;
                    if (selectedStores.includes(String(storeId))) {
                        currentStock += Number(s.stock || 0);
                    }
                });
            }
            item._calculatedStock = currentStock;
        });

        // 2. Ordenar items de menor a mayor existencia actual
        items.sort((a, b) => a._calculatedStock - b._calculatedStock);

        const rowsHtml = [];
        const hiddenIndices = [];
        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            // Recuperar valores calculados
            let currentStock = item._calculatedStock;

            // Sumar existencia mínima y máxima por depósitos seleccionados
            let minStock = 0;
            let maxStock = 0;

            if (item.parameters && Array.isArray(item.parameters)) {
                item.parameters.forEach(p => {
                    const storeId = p.store_Code || p.store_code || p.store;
                    if (!storeId) return;
                    if (selectedStores.includes(String(storeId))) {
                        minStock += Number(p.minimal_stock || 0);
                        maxStock += Number(p.maximum_stock || 0);
                    }
                });
            }

            // (El cálculo de currentStock ya se hizo arriba y se guardó en item._calculatedStock)

            // Ocultar solo si existe configuración de stock máximo (> 0) y la existencia actual lo supera
            const maxNum = Number(maxStock);
            const curNum = Number(currentStock);
            const isOverMax = isFinite(maxNum) && maxNum > 0 && isFinite(curNum) && curNum > maxNum;
            if (isOverMax) {
                hiddenIndices.push(i);
            }

            const suggestedQuantity = Math.max(0, Number(maxStock) - Number(currentStock));
            const deptVal = (item.department_description || item.product_department || '').toString();
            const brandVal = (item.product_mark || '').toString();
            const hasOtherProviders = Array.isArray(item.product_in_order) && item.product_in_order.length > 0;
            const rowHighlightClass = (item.highlight || hasOtherProviders) ? 'bg-yellow-100' : '';
            rowsHtml.push(`
            <tr class="hover:bg-gray-50 ${rowHighlightClass}" 
                data-department="${deptVal}" 
                data-brand="${brandVal}" 
                data-code="${item.product_code}" 
                data-desc="${item.product_description}"
                data-over-max="${isOverMax}"
                style="display: ${isOverMax ? 'none' : ''}">
                <td class="px-4 py-3 text-center"><input type="checkbox" class="select-product" value="${item.product_code}" data-index="${i}" ${selectedIndices.has(item.product_code) ? 'checked' : ''}></td>
                <td class="px-4 py-3">
                    <button type="button" class="product-detail-link text-blue-600 hover:underline" data-code="${item.product_code}">${item.product_description} (${item.product_code})</button>
                </td>
                <td class="px-4 py-3">${item.product_mark}</td>
                <td class="px-4 py-3">${item.department_description || item.product_department || ''}</td>
                <td class="px-4 py-3">
                    ${(() => {
                    try {
                        const units = (Array.isArray(item.units) && item.units.length)
                            ? item.units
                            : [{ unit_description: getDefaultUnit(item), conversion_factor: 1 }];
                        const defaultIdx = units.findIndex(u => (u && (u.main_unit === true || u.main_unit === 't' || u.main_unit === 1)));
                        const selectedIdx = defaultIdx >= 0 ? defaultIdx : 0;
                        const options = units.map((u, ui) => {
                            const text = (u && (u.unit_description)) || '';
                            // Asegurar que value sea el correlativo numérico o string vacío si no existe
                            const value = (u && u.correlative !== undefined && u.correlative !== null) ? u.correlative : '';
                            const factor = (u && u.conversion_factor != null) ? u.conversion_factor : 1;
                            const cost = (u && u.unitary_cost != null) ? u.unitary_cost : '';
                            const sel = ui === selectedIdx ? 'selected' : '';
                            return `<option value="${value}" data-factor="${String(factor)}" data-cost="${String(cost)}" ${sel}>${String(text)}</option>`;
                        }).join('');
                        return `<select class="unit-select border rounded px-2 py-1 text-sm" data-index="${i}">${options}</select>`;
                    } catch (e) {
                        return `<span>${getDefaultUnit(item)}</span>`;
                    }
                })()}
                </td>
                <td class="px-4 py-3 fecha-cell">${item.product_provider_emission_date || ''}</td>
                <td class="px-4 py-3 text-center">${minStock}</td>
                <td class="px-4 py-3 text-center">${maxStock}</td>
                <td class="px-4 py-3 text-center current-stock-cell" data-index="${i}" data-base-stock="${currentStock}">
                    ${(() => {
                    try {
                        const units = (Array.isArray(item.units) && item.units.length) ? item.units : [];
                        const selUnit = units.find(u => (u && (u.main_unit === true || u.main_unit === 't' || u.main_unit === 1))) || units[0] || null;
                        const factor = (selUnit && Number(selUnit.conversion_factor) > 0) ? Number(selUnit.conversion_factor) : 1;
                        return Number(Number(currentStock) / factor).toFixed(2);
                    } catch (e) {
                        return Number(currentStock).toFixed(2);
                    }
                })()}
                </td>
                <td class="px-4 py-3 text-right last-cost-cell" data-index="${i}">
                    ${(() => {
                    try {
                        const units = (Array.isArray(item.units) && item.units.length) ? item.units : [];
                        const selUnit = units.find(u => (u && (u.main_unit === true || u.main_unit === 't' || u.main_unit === 1))) || units[0] || null;
                        const cost = (selUnit && selUnit.unitary_cost != null) ? Number(selUnit.unitary_cost) : (item.product_provider_unitary_cost != null ? Number(item.product_provider_unitary_cost) : null);
                        return cost != null ? cost.toFixed(2) : '';
                    } catch (e) {
                        return item.product_provider_unitary_cost != null ? Number(item.product_provider_unitary_cost).toFixed(2) : '';
                    }
                })()}
                </td>
                <td class="px-4 py-3 text-center">${item.product_provider_document_no || ''}</td>
                <td class="px-4 py-3 text-center font-bold text-blue-600">
                <input type="number" value="${Number(suggestedQuantity).toFixed(2)}" min="0" class="w-20 border rounded px-2 py-1 text-sm purchase-qty-input" data-index="${i}">
                </td>
                <td class="px-4 py-3 text-center">
                    <input type="number" step="0.01" min="0" class="w-20 border rounded px-2 py-1 text-sm purchase-cost-input" data-index="${i}"
                           value="${(() => {
                    try {
                        const units = (Array.isArray(item.units) && item.units.length) ? item.units : [];
                        const selUnit = units.find(u => (u && (u.main_unit === true || u.main_unit === 't' || u.main_unit === 1))) || units[0] || null;
                        const cost = (selUnit && selUnit.unitary_cost != null) ? Number(selUnit.unitary_cost) : (item.product_provider_unitary_cost != null ? Number(item.product_provider_unitary_cost) : null);
                        return cost != null ? cost.toFixed(2) : '';
                    } catch (e) {
                        return item.product_provider_unitary_cost != null ? Number(item.product_provider_unitary_cost).toFixed(2) : '';
                    }
                })()}">
                </td>
                <td class="px-4 py-3 text-right">
                    <span class="subtotal-cell" data-index="${i}">0.00</span>
                </td>
                <td class="px-4 py-3 text-center">
                    ${(Array.isArray(item.product_in_order) && item.product_in_order.length > 0)
                    ? `<button type="button" class="order-details-link text-sm text-blue-600 hover:underline" data-index="${i}">Ver Detalles</button>`
                    : ''}
                </td>

                <td class="px-4 py-3 text-center">
                    <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-xs font-medium remove-product-btn flex items-center gap-1" data-index="${i}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                        
                    </button>
                </td>
            </tr>`);
        }
        if (rowsHtml.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">No hay productos para mostrar según los filtros y existencias.</td></tr>';
        } else {
            tableBody.innerHTML = rowsHtml.join('');
        }
        attachRowSelectionHandlers();
        // Mostrar/actualizar resumen de compra
        try { updatePurchaseSummaryVisibility(); computeAndRenderPurchaseSummary(); } catch (e) { }
        // Inicializar subtotales por fila
        try {
            document.querySelectorAll('.subtotal-cell').forEach(cell => {
                const idx = Number(cell.getAttribute('data-index'));
                if (Number.isFinite(idx)) {
                    updateRowSubtotal(idx);
                }
            });
        } catch (e) { }
        // Ajustar cabecera sticky según altura de filtros
        try { applyStickyLayout(); } catch (e) { }
        try { filterRows(); } catch (e) { }
        try { updateDisplayedProductsCount(); updateSelectedProductsCount(); } catch (e) { }
    }

    // Re-render al cambiar selección de depósitos
    storeCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            if (currentItems) {
                renderTable(currentItems);
            }
        });
    });

    function attachRowSelectionHandlers() {
        const rowCbs = document.querySelectorAll('.select-product');
        function getVisibleRowCheckboxes() {
            return Array.from(document.querySelectorAll('.select-product')).filter(cb => {
                const tr = cb.closest('tr');
                return tr && tr.style.display !== 'none';
            });
        }
        rowCbs.forEach(cb => {
            cb.addEventListener('change', () => {
                const code = cb.value;
                const idx = Number(cb.dataset.index);
                if (cb.checked) {
                    selectedIndices.add(code);
                } else {
                    selectedIndices.delete(code);
                }
                // Recalcular resumen
                try { updatePurchaseSummaryVisibility(); computeAndRenderPurchaseSummary(); } catch (e) { }
                try { updateRowSubtotal(idx); } catch (e) { }
                // Actualizar estado de "Seleccionar todos" solo considerando filas visibles
                const selectAllCb = document.getElementById('select-all-products');
                if (selectAllCb) {
                    const visibleCbs = getVisibleRowCheckboxes();
                    selectAllCb.checked = visibleCbs.length > 0 && visibleCbs.every(x => x.checked);
                }
                try { updateSelectedProductsCount(); } catch (e) { }
            });
        });
        const selectAllCb = document.getElementById('select-all-products');
        if (selectAllCb) {
            const visibleCbs = getVisibleRowCheckboxes();
            selectAllCb.checked = visibleCbs.length > 0 && visibleCbs.every(cb => cb.checked);
            selectAllCb.onclick = () => {
                const check = selectAllCb.checked;
                const visibleCbs = getVisibleRowCheckboxes();
                visibleCbs.forEach(cb => {
                    cb.checked = check;
                    const code = cb.value;
                    if (check) selectedIndices.add(code);
                    else selectedIndices.delete(code);
                });
                // Recalcular resumen
                try { updatePurchaseSummaryVisibility(); computeAndRenderPurchaseSummary(); } catch (e) { }
                try { updateSelectedProductsCount(); } catch (e) { }
            };
        }

        // Botones de eliminar producto: remueven la fila y actualizan el estado
        const removeBtns = document.querySelectorAll('.remove-product-btn');
        removeBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const idx = Number(btn.getAttribute('data-index'));
                if (!Number.isFinite(idx)) return;
                if (Array.isArray(currentItems)) {
                    const itemToRemove = currentItems[idx];
                    if (itemToRemove) {
                        selectedIndices.delete(itemToRemove.product_code);
                    }

                    // 2. Eliminar del arreglo principal
                    currentItems = currentItems.filter((_, i) => i !== idx);

                    // Re-render y re-aplicar filtros activos
                    renderTable(currentItems);
                    try { filterRows(); } catch (e) { }
                    // Recalcular resumen
                    try { updatePurchaseSummaryVisibility(); computeAndRenderPurchaseSummary(); } catch (e) { }
                }
            });
        });

        // Cambio de unidad: recalcular existencia actual mostrada según conversion_factor
        const unitSelects = document.querySelectorAll('.unit-select');
        unitSelects.forEach(sel => {
            sel.addEventListener('change', () => {
                const idx = Number(sel.getAttribute('data-index'));
                const opt = sel.options[sel.selectedIndex];
                const factor = (() => { const v = Number(opt && opt.getAttribute('data-factor')); return (isFinite(v) && v > 0) ? v : 1; })();
                const cell = document.querySelector(`.current-stock-cell[data-index="${idx}"]`);
                if (!cell) return;
                const base = Number(cell.getAttribute('data-base-stock')) || 0;
                const converted = base / factor;
                cell.textContent = Number(converted).toFixed(2);

                // Actualizar "Último Costo" segun unidad seleccionada
                const costAttr = opt ? opt.getAttribute('data-cost') : null;
                const costNum = costAttr != null && costAttr !== '' ? Number(costAttr) : null;
                const lastCell = document.querySelector(`.last-cost-cell[data-index="${idx}"]`);
                if (lastCell) {
                    lastCell.textContent = (costNum != null && isFinite(costNum)) ? costNum.toFixed(2) : '';
                }
                // Si el usuario desea que el costo de compra siga el costo de unidad seleccionada
                try {
                    const costInput = document.querySelector(`.purchase-cost-input[data-index="${idx}"]`);
                    if (costInput && (costNum != null && isFinite(costNum))) {
                        costInput.value = costNum.toFixed(2);
                    }
                } catch (e) { }
                // Recalcular resumen
                try { computeAndRenderPurchaseSummary(); } catch (e) { }
                try { updateRowSubtotal(idx); } catch (e) { }
            });
        });

        // Cambios en cantidad y costo de compra
        const qtyInputs = document.querySelectorAll('.purchase-qty-input');
        qtyInputs.forEach(inp => {
            const updateError = () => {
                const val = Number(inp.value);
                if (val <= 0) inp.classList.add('qty-error');
                else inp.classList.remove('qty-error');
            };
            inp.addEventListener('input', () => {
                try { sanitizeNonNegative(inp); } catch (e) { }
                try { updateError(); } catch (e) { }
                try { computeAndRenderPurchaseSummary(); } catch (e) { }
                try { updateRowSubtotal(Number(inp.dataset.index)); } catch (e) { }
            });
            inp.addEventListener('change', () => {
                try { sanitizeNonNegative(inp); } catch (e) { }
                try { updateError(); } catch (e) { }
                try { computeAndRenderPurchaseSummary(); } catch (e) { }
                try { updateRowSubtotal(Number(inp.dataset.index)); } catch (e) { }
            });
            // Verificación inicial
            updateError();
        });
        const costInputs = document.querySelectorAll('.purchase-cost-input');
        costInputs.forEach(inp => {
            inp.addEventListener('input', () => { try { sanitizeNonNegative(inp); } catch (e) { } try { computeAndRenderPurchaseSummary(); } catch (e) { } try { updateRowSubtotal(Number(inp.dataset.index)); } catch (e) { } });
            inp.addEventListener('change', () => { try { sanitizeNonNegative(inp); } catch (e) { } try { computeAndRenderPurchaseSummary(); } catch (e) { } try { updateRowSubtotal(Number(inp.dataset.index)); } catch (e) { } });
        });
    }

    async function fetchProviderDetails(code) {
        try {
            const response = await fetch(`/shopping/api/providers/details/${encodeURIComponent(code)}`);
            if (!response.ok) throw new Error('No se pudo obtener la información del proveedor');
            const data = await response.json();
            return data.provider || null;
        } catch (error) {
            console.error('Error fetching provider:', error);
            if (providerDetailsEl) providerDetailsEl.textContent = 'Detalles: error al cargar';
            return null;
        }
    }

    function renderProviderDetails(provider) {
        if (!providerDetailsEl || !provider) return;
        // Persistir detalles del proveedor para el guardado
        selectedProviderDetails = provider;
        const rif = provider.provider_id || provider.rif || '---';
        const tel = provider.provider_phone || provider.phone || '---';
        const dir = provider.address || provider.provider_address || '---';
    }

    // ----- Filtros de tabla (departamentos, marcas y buscador) -----
    const filtersBar = document.getElementById('table-filters');
    const deptToggle = document.getElementById('dept-toggle');
    const deptPanel = document.getElementById('dept-panel');
    const deptSummary = document.getElementById('dept-selected-summary');
    const deptOptions = document.getElementById('dept-options');
    const deptAllCheckbox = document.getElementById('dept-all');
    const deptClearBtn = document.getElementById('dept-clear');

    const brandToggle = document.getElementById('brand-toggle');
    const brandPanel = document.getElementById('brand-panel');
    const brandSummary = document.getElementById('brand-selected-summary');
    const brandOptions = document.getElementById('brand-options');
    const brandAllCheckbox = document.getElementById('brand-all');
    const brandClearBtn = document.getElementById('brand-clear');

    const tableSearchInput = document.getElementById('table-product-search');

    function normalizeText(s) { return (s || '').toString().trim().toLowerCase(); }

    function buildOptions(container, values, cls) {
        if (!container) return;
        container.innerHTML = '';
        values.forEach(v => {
            const label = document.createElement('label');
            label.className = 'flex items-center gap-2 text-sm';
            label.innerHTML = `<input type="checkbox" class="${cls}" value="${v}"><span>${v || '(vacío)'}</span>`;
            container.appendChild(label);
        });
    }

    function uniqueSorted(vals) {
        return Array.from(new Set(vals.map(v => (v || '').toString().trim()))).sort((a, b) => a.localeCompare(b));
    }

    function initFilters(items) {
        try {
            if (!Array.isArray(items) || items.length === 0) return;
            // Construir valores únicos
            const depts = uniqueSorted(items.map(i => i.department_description || i.product_department || ''));
            const brands = uniqueSorted(items.map(i => i.product_mark || ''));
            // Pintar opciones
            buildOptions(deptOptions, depts, 'dept-check');
            buildOptions(brandOptions, brands, 'brand-check');
            // Mostrar barra de filtros
            if (filtersBar) filtersBar.classList.remove('hidden');

            updateDropdownSummary();
            filterRows();

            // Botones limpiar
            deptClearBtn && deptClearBtn.addEventListener('click', () => {
                document.querySelectorAll('.dept-check').forEach(c => c.checked = false);
                if (deptAllCheckbox) deptAllCheckbox.checked = false;
                updateDropdownSummary();
                filterRows();
            });
            brandClearBtn && brandClearBtn.addEventListener('click', () => {
                document.querySelectorAll('.brand-check').forEach(c => c.checked = false);
                if (brandAllCheckbox) brandAllCheckbox.checked = false;
                updateDropdownSummary();
                filterRows();
            });

            // 'Todos'
            deptAllCheckbox && deptAllCheckbox.addEventListener('change', function () {
                const checked = !!this.checked;
                document.querySelectorAll('.dept-check').forEach(c => c.checked = checked);
                updateDropdownSummary();
                filterRows();
            });
            brandAllCheckbox && brandAllCheckbox.addEventListener('change', function () {
                const checked = !!this.checked;
                document.querySelectorAll('.brand-check').forEach(c => c.checked = checked);
                updateDropdownSummary();
                filterRows();
            });

            // Cambios individuales
            document.addEventListener('change', (e) => {
                if (e.target.classList && e.target.classList.contains('dept-check')) {
                    const anyUnchecked = Array.from(document.querySelectorAll('.dept-check')).some(c => !c.checked);
                    if (deptAllCheckbox) deptAllCheckbox.checked = !anyUnchecked && document.querySelectorAll('.dept-check').length > 0;
                    updateDropdownSummary();
                    filterRows();
                }
                if (e.target.classList && e.target.classList.contains('brand-check')) {
                    const anyUncheckedB = Array.from(document.querySelectorAll('.brand-check')).some(c => !c.checked);
                    if (brandAllCheckbox) brandAllCheckbox.checked = !anyUncheckedB && document.querySelectorAll('.brand-check').length > 0;
                    updateDropdownSummary();
                    filterRows();
                }
            });

            // Toggle panels
            function togglePanel(panel, btn) {
                const isOpen = !panel.classList.contains('hidden');
                [deptPanel, brandPanel].forEach(p => p && p.classList.add('hidden'));
                if (!isOpen) { panel.classList.remove('hidden'); btn && btn.setAttribute('aria-expanded', 'true'); }
                else { panel.classList.add('hidden'); btn && btn.setAttribute('aria-expanded', 'false'); }
            }
            deptToggle && deptToggle.addEventListener('click', () => togglePanel(deptPanel, deptToggle));
            brandToggle && brandToggle.addEventListener('click', () => togglePanel(brandPanel, brandToggle));
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#dept-dropdown') && !e.target.closest('#brand-dropdown')) {
                    deptPanel && deptPanel.classList.add('hidden');
                    brandPanel && brandPanel.classList.add('hidden');
                }
            });

            tableSearchInput && tableSearchInput.addEventListener('input', filterRows);

            // Reaplicar sticky al mostrar filtros
            try { applyStickyLayout(); } catch (e) { }
        } catch (e) { console.error('initFilters error:', e); }
    }

    function getCheckedValues(selector) {
        return Array.from(document.querySelectorAll(selector))
            .filter(c => c.checked)
            .map(c => normalizeText(c.value));
    }

    function updateDropdownSummary() {
        try {
            const dVals = getCheckedValues('.dept-check');
            deptSummary && (deptSummary.textContent = dVals.length ? (dVals.length === 1 ? dVals[0] : dVals.length + ' seleccionados') : 'Todos');
            const bVals = getCheckedValues('.brand-check');
            brandSummary && (brandSummary.textContent = bVals.length ? (bVals.length === 1 ? bVals[0] : bVals.length + ' seleccionadas') : 'Todas');
        } catch (e) { }
    }

    // Contadores: productos mostrados y seleccionados
    function updateDisplayedProductsCount() {
        try {
            const rows = Array.from(document.querySelectorAll('#products-table-body tr'));
            const count = rows.filter(tr => tr.style.display !== 'none' && tr.querySelector('.select-product')).length;
            const el = document.getElementById('displayed-products-count');
            if (el) el.textContent = String(count);
        } catch (e) { }
    }
    function updateSelectedProductsCount() {
        try {
            const el = document.getElementById('selected-products-count');
            if (el) el.textContent = String(selectedIndices ? selectedIndices.size : 0);
        } catch (e) { }
    }

    function filterRows() {
        try {
            const q = normalizeText(tableSearchInput && tableSearchInput.value);
            const depts = getCheckedValues('.dept-check');
            const brands = getCheckedValues('.brand-check');
            const rows = Array.from(document.querySelectorAll('#products-table-body tr'));
            rows.forEach(row => {
                const rowDept = normalizeText(row.getAttribute('data-department'));
                const rowBrand = normalizeText(row.getAttribute('data-brand'));
                const code = normalizeText(row.getAttribute('data-code'));
                const desc = normalizeText(row.getAttribute('data-desc'));
                const isOverMax = row.getAttribute('data-over-max') === 'true';

                const matchesDept = (depts.length === 0) || depts.includes(rowDept);
                const matchesBrand = (brands.length === 0) || brands.includes(rowBrand);
                const matchesQuery = !q || code.includes(q) || desc.includes(q);
                row.style.display = (matchesDept && matchesBrand && matchesQuery && !isOverMax) ? '' : 'none';
            });
            // Actualizar el estado del checkbox "Seleccionar todos" considerando solo filas visibles
            const selectAllCb = document.getElementById('select-all-products');
            if (selectAllCb) {
                const visibleCbs = Array.from(document.querySelectorAll('.select-product')).filter(cb => {
                    const tr = cb.closest('tr');
                    return tr && tr.style.display !== 'none';
                });
                selectAllCb.checked = visibleCbs.length > 0 && visibleCbs.every(cb => cb.checked);
            }
            // Actualizar contador de productos mostrados
            updateDisplayedProductsCount();
        } catch (e) { }
    }

    // Sticky: calcular offset de cabecera basado en altura de filtros
    function applyStickyLayout() {
        const filters = document.getElementById('table-filters');
        const thead = document.getElementById('table-header');
        if (!thead) return;
        const isHidden = filters && filters.classList.contains('hidden');
        const h = (!filters || isHidden) ? 0 : filters.offsetHeight;
        thead.style.top = h + 'px';
    }

    // Ajustar en resize
    window.addEventListener('resize', function () { try { applyStickyLayout(); } catch (e) { } });
</script>

<!-- Summary Script: cálculo de detalle y totales de la compra -->
<script>
    function updatePurchaseSummaryVisibility() {
        try {
            const container = document.getElementById('purchase-summary-container');
            const anySelected = selectedIndices && selectedIndices.size > 0;
            if (!container) return;
            if (anySelected) container.classList.remove('hidden');
            else container.classList.add('hidden');
            // Actualizar estado de botones
            const btnToggle = document.getElementById('btn-toggle-summary');
            const btnModal = document.getElementById('btn-open-summary-modal');
            if (btnToggle) {
                btnToggle.disabled = !anySelected;
                const isHidden = container.classList.contains('hidden');
                btnToggle.textContent = isHidden ? 'Mostrar detalle' : 'Ocultar detalle';
            }
            if (btnModal) {
                btnModal.disabled = !anySelected;
            }
        } catch (e) { }
    }

    function computeAndRenderPurchaseSummary() {
        try {
            const tbody = document.getElementById('selected-products-table-body');
            const totalProductsEl = document.getElementById('total-selected-products-count');
            const totalQtyEl = document.getElementById('total-selected-quantity');
            const totalAmountEl = document.getElementById('total-purchase-amount');
            const topTotalAmountEl = document.getElementById('top-total-purchase-amount');

            if (!tbody || !Array.isArray(currentItems)) return;

            const rowsData = [];
            let totalProducts = 0;
            let totalQty = 0;
            let totalAmount = 0;

            selectedIndices.forEach(code => {
                const row = document.querySelector(`#products-table-body tr[data-code="${code}"]`);
                if (!row) return;
                const idx = row.querySelector('.select-product').dataset.index;
                const item = currentItems[idx];
                if (!item) return;
                const qtyInput = row.querySelector('.purchase-qty-input');
                const costInput = row.querySelector('.purchase-cost-input');
                const unitSel = row.querySelector('.unit-select');
                const unitText = unitSel ? unitSel.options[unitSel.selectedIndex].textContent : (getDefaultUnit(item) || '');
                const qty = qtyInput ? Number(qtyInput.value) : 0;
                const cost = costInput ? Number(costInput.value) : 0;
                const subtotal = (isFinite(qty) ? qty : 0) * (isFinite(cost) ? cost : 0);
                if ((isFinite(qty) && qty > 0)) {
                    totalProducts += 1;
                    totalQty += qty;
                    totalAmount += subtotal;
                }
                rowsData.push({
                    code: item.product_code,
                    desc: item.product_description,
                    unit: unitText,
                    qty: qty,
                    cost: cost,
                    subtotal: subtotal
                });
            });

            // Pintar tabla
            if (rowsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-500">No hay productos seleccionados</td></tr>';
            } else {
                tbody.innerHTML = rowsData.map(r => `
                    <tr>
                        <td class="px-4 py-2">${r.code || ''}</td>
                        <td class="px-4 py-2">${r.desc || ''}</td>
                        <td class="px-4 py-2 text-center">${r.unit || ''}</td>
                        <td class="px-4 py-2 text-right">${isFinite(r.qty) ? Number(r.qty).toFixed(2) : '0.00'}</td>
                        <td class="px-4 py-2 text-right">${isFinite(r.cost) ? Number(r.cost).toFixed(2) : '0.00'}</td>
                        <td class="px-4 py-2 text-right">${isFinite(r.subtotal) ? Number(r.subtotal).toFixed(2) : '0.00'}</td>
                    </tr>
                `).join('');
            }

            // Totales
            if (totalProductsEl) totalProductsEl.textContent = String(totalProducts);
            if (totalQtyEl) totalQtyEl.textContent = isFinite(totalQty) ? Number(totalQty).toFixed(2) : '0.00';
            if (totalAmountEl) totalAmountEl.textContent = isFinite(totalAmount) ? Number(totalAmount).toFixed(2) : '0.00';
            if (topTotalAmountEl) topTotalAmountEl.textContent = isFinite(totalAmount) ? Number(totalAmount).toFixed(2) : '0.00';

            // Visibilidad
            updatePurchaseSummaryVisibility();
        } catch (e) { console.error('computeAndRenderPurchaseSummary error:', e); }
    }

    function buildPurchaseSummaryHtml() {
        try {
            if (!Array.isArray(currentItems) || !selectedIndices || selectedIndices.size === 0) {
                return '<div class="p-4 text-sm text-gray-600">No hay productos seleccionados.</div>';
            }
            const rows = [];
            let totalProducts = 0, totalQty = 0, totalAmount = 0;
            selectedIndices.forEach(code => {
                const row = document.querySelector(`#products-table-body tr[data-code="${code}"]`);
                if (!row) return;
                const idx = row.querySelector('.select-product').dataset.index;
                const item = currentItems[idx];
                if (!item) return;
                const qtyInput = row.querySelector('.purchase-qty-input');
                const costInput = row.querySelector('.purchase-cost-input');
                const unitSel = row.querySelector('.unit-select');
                const unitText = unitSel ? unitSel.options[unitSel.selectedIndex].textContent : (getDefaultUnit(item) || '');
                const qty = qtyInput ? Number(qtyInput.value) : 0;
                const cost = costInput ? Number(costInput.value) : 0;
                const subtotal = (isFinite(qty) ? qty : 0) * (isFinite(cost) ? cost : 0);
                if ((isFinite(qty) && qty > 0)) {
                    totalProducts += 1;
                    totalQty += qty;
                    totalAmount += subtotal;
                }
                rows.push(`
                    <tr>
                        <td class="px-4 py-2">${item.product_code || ''}</td>
                        <td class="px-4 py-2">${item.product_description || ''}</td>
                        <td class="px-4 py-2 text-center">${unitText || ''}</td>
                        <td class="px-4 py-2 text-right">${isFinite(qty) ? Number(qty).toFixed(2) : '0.00'}</td>
                        <td class="px-4 py-2 text-right">${isFinite(cost) ? Number(cost).toFixed(2) : '0.00'}</td>
                        <td class="px-4 py-2 text-right">${isFinite(subtotal) ? Number(subtotal).toFixed(2) : '0.00'}</td>
                    </tr>
                `);
            });
            const header = `
                <div id="shopping-detail" class="flex gap-6 text-sm px-4 py-2 bg-white border-b" style="position: sticky; top: 0; z-index: 20;">
                    <span class="text-gray-700">Productos seleccionados: <strong>${String(totalProducts)}</strong></span>
                    <span class="text-gray-700">Cantidad total: <strong>${isFinite(totalQty) ? Number(totalQty).toFixed(2) : '0.00'}</strong></span>
                    <span class="text-gray-700">Total de la compra: <strong>${isFinite(totalAmount) ? Number(totalAmount).toFixed(2) : '0.00'}</strong></span>
                </div>`;
            const table = `
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-600 font-medium border-b" style="position: sticky; z-index: 10; background-color: #f3f4f6;">
                        <tr>
                            <th class="px-4 py-2">Código</th>
                            <th class="px-4 py-2">Descripción</th>
                            <th class="px-4 py-2 text-center">Unidad</th>
                            <th class="px-4 py-2 text-right">Cantidad</th>
                            <th class="px-4 py-2 text-right">Costo</th>
                            <th class="px-4 py-2 text-right">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>${rows.join('')}</tbody>
                </table>`;
            return header + table;
        } catch (e) {
            return '<div class="p-4 text-sm text-red-600">Error al construir detalle de compra.</div>';
        }
    }

    // Botones de acciones
    (function () {
        const btnToggle = document.getElementById('btn-toggle-summary');
        const btnModal = document.getElementById('btn-open-summary-modal');
        const btnSave = document.getElementById('btn-save-order');
        const summaryContainer = document.getElementById('purchase-summary-container');
        if (btnToggle && summaryContainer) {
            btnToggle.addEventListener('click', function () {
                const isHidden = summaryContainer.classList.contains('hidden');
                if (isHidden) summaryContainer.classList.remove('hidden');
                else summaryContainer.classList.add('hidden');
                // Actualizar texto y estados
                try { updatePurchaseSummaryVisibility(); } catch (e) { }
            });
        }
        if (btnModal) {
            btnModal.addEventListener('click', function () {
                const html = buildPurchaseSummaryHtml();
                if (typeof openPurchaseSummaryModal === 'function') {
                    openPurchaseSummaryModal(html);
                }
            });
        }

        // Guardar pedido: construir payload y enviar al backend
        if (btnSave) {
            btnSave.addEventListener('click', async function () {
                try {
                    // Validaciones básicas
                    if (!selectedProvider) {
                        alert('Primero seleccione un proveedor.');
                        return;
                    }
                    if (!Array.from(storeCheckboxes).some(cb => cb.checked)) {
                        alert('Seleccione al menos un depósito.');
                        return;
                    }
                    if (!selectedIndices || selectedIndices.size === 0) {
                        alert('Seleccione al menos un producto y cantidad > 0.');
                        return;
                    }

                    // Construir header
                    const coinSel = document.getElementById('select-coin');
                    const coinCode = coinSel ? String(coinSel.value || '02') : '02';
                    const creditDaysInput = document.getElementById('input-provider-credit-days');
                    const creditDays = creditDaysInput ? Number(creditDaysInput.value || 0) : 0;
                    const provider = selectedProviderDetails || selectedProvider || {};
                    const storeList = getSelectedStores();
                    const header = {
                        provider_code: provider.provider_code,
                        credit_days: creditDays,
                        coin_code: coinCode,
                    };

                    // Construir detalles
                    const details = [];
                    let lineNo = 1;
                    let grandTotal = 0;

                    for (const code of selectedIndices) {
                        const row = document.querySelector(`#products-table-body tr[data-code="${code}"]`);
                        if (!row) continue;
                        const idx = row.querySelector('.select-product').dataset.index;
                        const item = Array.isArray(currentItems) ? currentItems[idx] : null;
                        if (!item) continue;

                        const qtyInput = row.querySelector('.purchase-qty-input');
                        const costInput = row.querySelector('.purchase-cost-input');
                        const unitSel = row.querySelector('.unit-select');
                        const qty = qtyInput ? Number(qtyInput.value || 0) : 0;
                        const cost = costInput ? Number(costInput.value || 0) : 0;

                        if (!isFinite(qty) || qty <= 0) {
                            alert(`El producto "${item.product_description || item.product_code}" tiene una cantidad inválida (debe ser mayor a 0).`);
                            return;
                        }

                        const opt = unitSel ? unitSel.options[unitSel.selectedIndex] : null;
                        const unitValRaw = opt ? (opt.value || '') : '';
                        const convFactorRaw = opt ? opt.getAttribute('data-factor') : '1';
                        const convFactor = (() => { const v = Number(convFactorRaw); return isFinite(v) && v > 0 ? v : 1; })();
                        // Si unitValRaw es vacío, unitParsed será NaN, lo convertimos a null o 0 según requiera el backend
                        const unitParsed = unitValRaw !== '' ? parseInt(unitValRaw, 10) : null;
                        const lineTotal = qty * cost;
                        grandTotal += lineTotal;

                        details.push({
                            code_product: item.product_code || '',
                            amount: qty,
                            unit: unitParsed, // Puede ser null si no hay unidad seleccionada
                            unitary_cost: cost,
                            total_net_cost: lineTotal,
                            total_cost: lineTotal,
                            total_net_gross: lineTotal,
                            total_gross: lineTotal,
                            total_net: lineTotal,
                            total: lineTotal,
                            coin_code: coinCode,
                            unit_desc: opt ? opt.textContent || '' : ''
                        });
                        console.log('Detalle agregado:', details[details.length - 1]);
                    }

                    if (details.length === 0) {
                        alert('No hay productos seleccionados para guardar.');
                        return;
                    }

                    // Totales del header
                    header.total_amount = grandTotal;
                    header.total_details = grandTotal;
                    header.total_net_details = grandTotal;
                    header.total_net = grandTotal;
                    header.total = grandTotal;
                    header.total_operation = grandTotal;

                    const payload = { ...header, details };

                    // Enviar al backend
                    const resp = await fetch('/shopping/api/shopping/operation/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await resp.json();
                    if (resp.ok && data && data.ok) {
                        alert(`Orden guardada. ID: ${data.message}`);
                        // Opcional: limpiar selección y recomputar
                        // selectedIndices.clear();
                        // computeAndRenderPurchaseSummary();
                    } else {
                        alert(`Error al guardar: ${data && data.error ? data.error : 'Error desconocido'}`);
                    }
                } catch (err) {
                    console.error('Error al guardar orden:', err);
                    alert('Error inesperado al guardar la orden.');
                }
            });
        }
    })();
</script>

<!-- Modal Script: abrir/cerrar y tecla ESC para resumen -->
<script>
    (function () {
        const modal = document.getElementById('purchase-summary-modal');
        const dialog = document.getElementById('purchase-summary-dialog');
        const closeBtn = document.getElementById('purchase-summary-close');
        const content = document.getElementById('purchase-summary-content');

        const style = document.createElement('style');
        style.textContent = `
        #purchase-summary-modal { opacity: 0; transition: opacity 200ms ease; }
        #purchase-summary-modal.modal-show { opacity: 1; }
        #purchase-summary-dialog { transform: scale(0.98); opacity: 0; transition: transform 200ms ease, opacity 200ms ease; }
        #purchase-summary-dialog.dialog-show { transform: scale(1); opacity: 1; }
        `;
        document.head.appendChild(style);

        function openPurchaseSummaryModal(htmlContent) {
            if (content) {
                content.innerHTML = htmlContent || '';
            }
            if (modal) {
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.add('modal-show');
                    if (dialog) dialog.classList.add('dialog-show');
                });
            }
        }

        function closePurchaseSummaryModal() {
            if (modal) {
                modal.classList.remove('modal-show');
                if (dialog) dialog.classList.remove('dialog-show');
                const onEnd = () => {
                    modal.classList.add('hidden');
                    modal.removeEventListener('transitionend', onEnd);
                };
                modal.addEventListener('transitionend', onEnd, { once: true });
            }
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', closePurchaseSummaryModal);
        }
        if (modal) {
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closePurchaseSummaryModal();
                }
            });
        }
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                if (modal && !modal.classList.contains('hidden')) {
                    closePurchaseSummaryModal();
                }
            }
        });

        window.openPurchaseSummaryModal = openPurchaseSummaryModal;
        window.closePurchaseSummaryModal = closePurchaseSummaryModal;
    })();
</script>

<!-- Modal Script: abrir/cerrar y tecla ESC -->
<script>
    (function () {
        const modal = document.getElementById('product-detail-modal');
        const dialog = document.getElementById('product-detail-dialog');
        const closeBtn = document.getElementById('product-detail-close');
        const tabsBar = document.getElementById('product-detail-tabs');
        const generalPanel = document.getElementById('product-detail-tab-general');
        const parametrosPanel = document.getElementById('product-detail-tab-parametros');
        const generalContent = document.getElementById('product-detail-tab-general-content');

        // Animaciones suaves para overlay y diálogo
        const style = document.createElement('style');
        style.textContent = `
        #product-detail-modal { opacity: 0; transition: opacity 200ms ease; }
        #product-detail-modal.modal-show { opacity: 1; }
        #product-detail-dialog { transform: scale(0.98); opacity: 0; transition: transform 200ms ease, opacity 200ms ease; }
        #product-detail-dialog.dialog-show { transform: scale(1); opacity: 1; }
        `;
        document.head.appendChild(style);

        // Activación de pestañas
        function activateTab(name) {
            try {
                const buttons = (tabsBar ? tabsBar.querySelectorAll('.tab-link') : []);
                buttons.forEach(btn => {
                    const isActive = btn.getAttribute('data-tab') === name;
                    // Estado visual activo/inactivo
                    btn.classList.toggle('text-indigo-600', isActive);
                    btn.classList.toggle('text-gray-600', !isActive);
                    btn.classList.toggle('border-indigo-600', isActive);
                    btn.classList.toggle('border-transparent', !isActive);
                    btn.classList.toggle('border-b-2', true);
                    btn.setAttribute('aria-selected', String(isActive));
                });
                if (generalPanel && parametrosPanel) {
                    if (name === 'general') {
                        generalPanel.classList.remove('hidden');
                        parametrosPanel.classList.add('hidden');
                    } else {
                        parametrosPanel.classList.remove('hidden');
                        generalPanel.classList.add('hidden');
                    }
                }
            } catch (e) { }
        }

        // Listeners para cambio de pestañas
        if (tabsBar) {
            tabsBar.addEventListener('click', (e) => {
                const target = e.target.closest('.tab-link');
                if (!target) return;
                const tab = target.getAttribute('data-tab');
                if (tab) activateTab(tab);
            });
        }

        function openProductDetailModal(htmlContent) {
            if (generalContent) {
                if (htmlContent && String(htmlContent).trim().length > 0) {
                    generalContent.innerHTML = htmlContent;
                }
                // Si no hay contenido proporcionado, mantenemos el HTML existente (párrafo por defecto)
            }
            if (modal) {
                modal.classList.remove('hidden');
                // Activar por defecto la pestaña General
                activateTab('general');
                // Forzar animación en el siguiente frame
                requestAnimationFrame(() => {
                    modal.classList.add('modal-show');
                    if (dialog) dialog.classList.add('dialog-show');
                });
            }
        }

        function closeProductDetailModal() {
            if (modal) {
                modal.classList.remove('modal-show');
                if (dialog) dialog.classList.remove('dialog-show');
                const onEnd = () => {
                    modal.classList.add('hidden');
                    modal.removeEventListener('transitionend', onEnd);
                };
                modal.addEventListener('transitionend', onEnd, { once: true });
            }
        }

        // Cerrar con botón de cerrar
        if (closeBtn) {
            closeBtn.addEventListener('click', closeProductDetailModal);
        }

        // Cerrar al hacer click en el fondo (fuera del diálogo)
        if (modal) {
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closeProductDetailModal();
                }
            });
        }

        // Cerrar con tecla ESCAPE
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                if (modal && !modal.classList.contains('hidden')) {
                    closeProductDetailModal();
                }
            }
        });

        // Exponer funciones globalmente para uso externo
        window.openProductDetailModal = openProductDetailModal;
        window.closeProductDetailModal = closeProductDetailModal;
    })();
</script>
<style>
    /* Reducción de fuente para toda la vista auto-order */
    #auto-order-page {
        font-size: 12px !important;
    }

    #auto-order-page table,
    #auto-order-page th,
    #auto-order-page td,
    #auto-order-page h1,
    #auto-order-page h2,
    #auto-order-page h3,
    #auto-order-page p,
    #auto-order-page label,
    #auto-order-page .text-xs,
    #auto-order-page .text-sm,
    #auto-order-page .text-base,
    #auto-order-page .text-lg,
    #auto-order-page .text-xl,
    #auto-order-page .text-2xl {
        font-size: 12px !important;
    }

    #auto-order-page input,
    #auto-order-page select,
    #auto-order-page button,
    #auto-order-page textarea {
        font-size: 12px !important;
    }

    /* Separadores de columnas y filas para mejor legibilidad */
    #auto-order-page table thead th,
    #auto-order-page table tbody td {
        border-right: 1px solid rgba(0, 0, 0, 0.08);
    }

    #auto-order-page table thead th:last-child,
    #auto-order-page table tbody td:last-child {
        border-right: none;
    }

    #auto-order-page table tbody tr {
        border-bottom: 1px solid rgba(0, 0, 0, 0.08) !important;
    }

    /* Hover más oscuro en filas */
    #auto-order-page table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.07) !important;
    }

    /* Columna Fecha: sin salto de línea y ancho según contenido */
    #auto-order-page .fecha-cell {
        white-space: nowrap;
    }

    #auto-order-page col.fecha-col {
        width: 1%;
    }
</style>
{% endblock %}