<!-- este documento muestra las operaciones de ordendes de recoleccion para realizar un chequeo y contar la mercancia
para que coincida con lo que se va a trasladar entre depositos. -->

{% extends "base.html" %}

{% block content %}
<div class="mx-auto px-4 py-6">
   <h1 class="text-xl font-semibold mb-4">Chequeo de Orden de Recolección</h1>
   <style>
      /* Resaltado fuerte para la fila encontrada por búsqueda */
      .collection-highlight {
         background-color: #fff7ed; /* naranja muy claro */
         box-shadow: inset 0 0 0 9999px rgba(255, 186, 73, 0.15);
         outline: 2px solid #f59e0b;
      }
      .collection-highlight td { transition: background-color .15s ease; }
   </style>

   <form method="get" class="mb-6 flex items-end gap-3 {{ 'hidden' if correlative and header and not validated else '' }}">
      <div>
         <label for="correlative" class="block text-sm font-medium text-gray-700">Ingrese el numero de <b>Correlativo</b> del documento</label>
         <input type="number" name="correlative" id="correlative" required class="border rounded px-3 py-2 w-48" placeholder="Ingrese codigo de barra" value="{{ correlative if correlative else '' }}">
      </div>
      <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Cargar</button>
   </form>

   <div id="check-meta" data-correlative="{{ correlative if correlative else '' }}" data-not-found="{{ '1' if correlative and not header else '0' }}"></div>
   {% if correlative and header and not validated %}
      <div class="mb-4 text-sm text-gray-600 space-y-1">
         <p><span class="font-medium">Correlativo:</span> {{ correlative }}</p>
         <p><span class="font-medium">Documento:</span> {{ header.document_no }}</p>
         <p><span class="font-medium">Depósito origen:</span> {{ header.origin_store_description }}</p>
         <p><span class="font-medium">Depósito destino:</span> {{ header.destination_store_description }}</p>
         <p><span class="font-medium">Fecha emisión:</span> {{ header.emission_date }}</p>
      </div>

      <!-- Barra de acciones -->
      <div class="flex flex-wrap items-center gap-3 mb-4">
         <div>
            <label for="product-search" class="text-sm font-medium text-gray-700">Buscar código</label>
            <input id="product-search" type="search" placeholder="Código" class="border rounded px-2 py-1 text-sm w-48" />
         </div>
         <div>
            <label for="counted-qty" class="text-sm font-medium text-gray-700">Cantidad contada</label>
            <input id="counted-qty" type="number" step="any" min="0" class="border rounded px-2 py-1 text-sm w-32" />
         </div>
         <button id="apply-count" type="button" class="px-3 py-1 bg-green-600 text-white rounded">Aplicar conteo</button>
         <button id="finalize-transfer" type="button" class="px-3 py-1 bg-blue-600 text-white rounded">Generar TRASLADO en espera</button>
         <span id="status-msg" class="text-sm text-gray-700"></span>
      </div>

      <!-- Modal conteo producto (similar a minmax-modal pero simplificado) -->
      <div id="count-modal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
         <div class="bg-white rounded shadow-lg w-full max-w-md p-4 space-y-4">
            <h2 class="text-lg font-semibold">Conteo de producto</h2>
            <div class="text-sm text-gray-600"><span class="font-medium">Código:</span> <span id="cm-code" class="font-mono"></span></div>
            <div class="text-sm text-gray-600"><span class="font-medium">Descripción:</span> <span id="cm-desc"></span></div>
            <div class="text-sm text-gray-600"><span class="font-medium">Unidad:</span> <span id="cm-unit"></span></div>
            <div class="text-sm text-gray-600"><span class="font-medium">Cant. Orden:</span> <span id="cm-original"></span></div>
            <div class="flex items-center gap-3">
               <label for="cm-qty" class="w-32 text-sm text-gray-700">Cantidad contada</label>
               <input id="cm-qty" type="number" step="any" min="0" class="border rounded px-2 py-1 w-40 text-right" />
            </div>
            <p id="cm-status" class="text-sm"></p>
            <div class="flex justify-end gap-2 pt-2">
               <button type="button" id="cm-cancel" class="px-3 py-1 rounded bg-gray-200">Cancelar</button>
               <button type="button" id="cm-apply" class="px-3 py-1 rounded bg-indigo-600 text-white">Aplicar Conteo</button>
            </div>
         </div>
      </div>
         <!-- Modal alerta diferencia en conteo -->
         <div id="mismatch-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
            <div class="absolute inset-0 bg-black/40"></div>
            <div class="relative bg-white rounded shadow-lg w-full max-w-md p-4 flex flex-col gap-4 border-2 border-red-600">
               <div class="flex items-center gap-2">
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-600 text-white font-bold">!</span>
                  <h3 class="text-lg font-semibold text-red-700">Diferencia en conteo</h3>
               </div>
               <p class="text-sm text-red-700" id="mmw-message"></p>
               <div class="text-xs text-red-600" id="mmw-detail"></div>
               <div class="flex justify-end">
                  <button type="button" id="mmw-close" class="px-4 py-1 rounded bg-red-600 text-white">Cerrar</button>
               </div>
            </div>
         </div>
         <!-- Modal confirmar validación con diferencias -->
         <div id="diff-validation-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
            <div class="absolute inset-0 bg-black/40"></div>
            <div class="relative bg-white rounded shadow-lg w-full max-w-md p-4 flex flex-col gap-4 border-2 border-yellow-500">
               <div class="flex items-center gap-2">
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-yellow-500 text-white font-bold">?</span>
                  <h3 class="text-lg font-semibold text-yellow-700">Validar con diferencias</h3>
               </div>
               <p class="text-sm text-yellow-700" id="diff-validation-text">Se detectaron diferencias. ¿Desea generar el traslado en espera con las diferencias encontradas?</p>
               <div class="flex justify-end gap-2">
                  <button type="button" id="diff-no" class="px-4 py-1 rounded bg-gray-200 text-gray-800">No, seguir contando</button>
                  <button type="button" id="diff-yes" class="px-4 py-1 rounded bg-yellow-600 text-white">Sí, validar</button>
               </div>
            </div>
         </div>

      <!-- Modal agregar producto no encontrado -->
      <div id="add-item-modal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
         <div class="bg-white rounded shadow-lg w-full max-w-md p-4 space-y-4">
            <h2 class="text-lg font-semibold">Agregar producto a la orden</h2>
            <form id="add-item-form" class="space-y-3">
               <input type="hidden" name="correlative" value="{{ correlative }}" />
               <div>
                  <label class="block text-sm font-medium text-gray-700">Código</label>
                  <input id="add-code" name="product_code" readonly class="border rounded px-2 py-1 w-full bg-gray-100" />
               </div>
               <div>
                  <label class="block text-sm font-medium text-gray-700">Descripción</label>
                  <input id="add-description" readonly class="border rounded px-2 py-1 w-full bg-gray-100" />
               </div>
                  <div>
                     <label class="block text-sm font-medium text-gray-700">Unidad</label>
                     <input id="add-unit" readonly class="border rounded px-2 py-1 w-full bg-gray-100" />
                  </div>
                  <div>
                     <label class="block text-sm font-medium text-gray-700">Stock en origen</label>
                     <input id="add-stock" readonly class="border rounded px-2 py-1 w-full bg-gray-100" />
                  </div>
               <div>
                  <label class="block text-sm font-medium text-gray-700">Cantidad</label>
                  <input id="add-quantity" name="quantity" type="number" step="any" min="0" placeholder="0" class="border rounded px-2 py-1 w-full" required />
               </div>
               <div class="flex justify-end gap-2 pt-2">
                  <button type="button" id="add-cancel" class="px-3 py-1 rounded border">Cancelar</button>
                  <button type="submit" class="px-3 py-1 rounded bg-indigo-600 text-white">Agregar</button>
               </div>
               <p id="add-item-status" class="text-sm"></p>
            </form>
         </div>
      </div>

      <div class="overflow-x-auto overflow-y-auto max-h-[60vh] border rounded">
         <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
               <tr>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Código</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unidad</th>
                  <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Cant. Orden</th>
                  <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Cant. Contada</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Estado</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Opciones</th>
               </tr>
            </thead>
            <tbody id="collection-items" class="bg-white divide-y divide-gray-200 text-sm">
               {% for item in items %}
                  <tr data-code="{{ item.code_product }}">
                     <td class="px-3 py-2 font-mono">{{ item.code_product }}</td>
                     <td class="px-3 py-2">{{ item.description_product }}</td>
                     <td class="px-3 py-2">{{ item.unit_description }}</td>
                     <td class="px-3 py-2 text-right" data-original="{{ item.amount }}">{{ item.amount }}</td>
                     <td class="px-3 py-2 text-right counted-cell" data-counted="">
                        <span class="text-gray-400 italic">Sin conteo</span>
                     </td>
                     <td class="px-3 py-2 text-right status-cell">
                        <span class="inline-block px-2 py-1 rounded bg-gray-200 text-gray-700 text-xs">Pendiente</span>
                        </td>
                        <td class="px-3 py-2 text-right">
                           <button type="button" class="delete-item px-2 py-1 text-xs rounded bg-red-600 text-white" data-code="{{ item.code_product }}">Eliminar</button>
                     </td>
                  </tr>
               {% endfor %}
               {% if not items %}
                 <tr><td colspan="8" class="px-3 py-4 text-center text-gray-500">Sin detalles para este correlativo.</td></tr>
               {% endif %}
            </tbody>
         </table>
      </div>

   {% elif correlative and validated %}
      <div class="mt-2 p-4 border rounded bg-green-50 text-sm text-green-800">
         <p><span class="font-medium">Orden ya validada:</span> {{ header.description }}</p>
         <p>Depósito origen: {{ header.store }} | Depósito destino: {{ header.destination_store }}</p>
         <p>Fecha emisión: {{ header.emission_date }}</p>
      </div>
   {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
            // Alertar si no se encontró la orden pero mantener el input visible/habilitado
            const metaDiv = document.getElementById('check-meta');
            const NOT_FOUND = metaDiv ? (metaDiv.dataset.notFound === '1') : false;
            if (NOT_FOUND) {
               alert('No se encontró una ORDER_COLLECTION en espera con correlativo {{ correlative }}.');
               try { document.getElementById('correlative').focus(); } catch (e) {}
            }
            // Obtener correlativo desde data attribute para evitar conflictos de lint
            const rawCorr = metaDiv ? metaDiv.dataset.correlative : '';
            const correlative = rawCorr ? parseInt(rawCorr, 10) : null;
   const searchInput = document.getElementById('product-search');
   const countedInput = document.getElementById('counted-qty');
   const applyBtn = document.getElementById('apply-count');
   const finalizeBtn = document.getElementById('finalize-transfer');
   const statusMsg = document.getElementById('status-msg');
   const tableBody = document.getElementById('collection-items');
   if (!tableBody) return;

     // Elementos modal conteo
     const countModal = document.getElementById('count-modal');
     const cmCode = document.getElementById('cm-code');
     const cmDesc = document.getElementById('cm-desc');
     const cmUnit = document.getElementById('cm-unit');
     const cmOriginal = document.getElementById('cm-original');
     const cmQty = document.getElementById('cm-qty');
     const cmStatus = document.getElementById('cm-status');
     const cmCancel = document.getElementById('cm-cancel');
     const cmApply = document.getElementById('cm-apply');
   // Mismatch modal elementos
   const mismatchModal = document.getElementById('mismatch-modal');
   const mmwMessage = document.getElementById('mmw-message');
   const mmwDetail = document.getElementById('mmw-detail');
   const mmwClose = document.getElementById('mmw-close');
   // Modal validación con diferencias
   const diffValidationModal = document.getElementById('diff-validation-modal');
   const diffYes = document.getElementById('diff-yes');
   const diffNo = document.getElementById('diff-no');
   window.__awaitDiffValidation = false; // bandera para abrir modal de confirmación al cerrar mismatch si corresponde

     function openCountModal(row){
        if(!row) return;
        const code = (row.dataset.code||'').toUpperCase();
        const desc = row.children[1] ? row.children[1].textContent.trim() : '';
        const unit = row.children[2] ? row.children[2].textContent.trim() : '';
        const originalRaw = row.querySelector('[data-original]') ? row.querySelector('[data-original]').dataset.original : '';
        let originalFmt = originalRaw;
        try { const n = Number(originalRaw); if(!isNaN(n)) originalFmt = n.toFixed(3); } catch(_){}
        cmCode.textContent = code;
        cmDesc.textContent = desc;
        if(cmUnit) cmUnit.textContent = unit || 'N/D';
        if(cmOriginal) cmOriginal.textContent = originalFmt || 'N/D';
        cmQty.value = '';
        cmStatus.textContent = '';
        cmStatus.className = 'text-sm text-gray-600';
        countModal.classList.remove('hidden');
        setTimeout(()=>{ try{ cmQty.focus(); cmQty.select(); }catch(e){} },50);
     }
     function closeCountModal(){ countModal.classList.add('hidden'); }
     cmCancel && cmCancel.addEventListener('click', ()=>{ closeCountModal(); searchInput.focus(); });
     cmApply && cmApply.addEventListener('click', ()=>{
        const code = cmCode.textContent.trim();
        if(!code){ cmStatus.textContent='Código vacío'; cmStatus.className='text-sm text-red-600'; return; }
        const row = findRowByCode(code);
        if(!row){ cmStatus.textContent='Fila no encontrada'; cmStatus.className='text-sm text-red-600'; return; }
        const qtyRaw = cmQty.value.trim();
        let countedVal = Number(String(qtyRaw).replace(',', '.'));
        if(isNaN(countedVal) || countedVal < 0){ cmStatus.textContent='Cantidad inválida'; cmStatus.className='text-sm text-red-600'; return; }
        // Reutilizar flujo existente: establecer inputs originales y disparar applyBtn
        searchInput.value = code;
        countedInput.value = countedVal;
        closeCountModal();
        applyBtn.click();
     });
     cmQty && cmQty.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); cmApply.click(); } });

   function normalize(v){ return (v||'').toString().trim().toLowerCase(); }
      function findRowByCode(code){
         const q = (code||'').toString().trim().toLowerCase();
         const rows = Array.from(tableBody.querySelectorAll('tr[data-code]'));
         return rows.find(r => (r.dataset.code||'').toLowerCase() === q) || null;
      }
   function setStatus(message, kind='info'){
      statusMsg.textContent = message;
      statusMsg.className = 'text-sm ' + (kind==='error' ? 'text-red-600' : kind==='success' ? 'text-green-600' : 'text-gray-700');
   }
   function hasDifferences(){
      return Array.from(document.querySelectorAll('#collection-items tr[data-code]'))
         .some(r => r.classList.contains('bg-yellow-50')); // diferencia marcada
   }
   function markRow(row, original, counted){
      const statusCell = row.querySelector('.status-cell');
      const countedCell = row.querySelector('.counted-cell');
      if (!statusCell || !countedCell) return;
      countedCell.dataset.counted = counted;
      countedCell.innerHTML = `<span>${Number(counted).toFixed(3)}</span>`;
      let diff = Math.abs(Number(original) - Number(counted)) < 1e-9;
      if (diff){
         statusCell.innerHTML = '<span class="inline-block px-2 py-1 rounded bg-green-100 text-green-700 text-xs">Ok</span>';
         row.classList.remove('bg-yellow-50');
         // Si cuadra, ocultar la fila
          row.style.display = 'none';
          setStatus('Producto conciliado y ocultado de la lista', 'success');
      } else {
         statusCell.innerHTML = '<span class="inline-block px-2 py-1 rounded bg-yellow-200 text-yellow-800 text-xs">Ajustado</span>';
         row.classList.add('bg-yellow-50');
             const code = (row.dataset.code||'').toUpperCase();
             openMismatchModal(code, original, counted);
             // Si tras aplicar este conteo ya no quedan pendientes y existen diferencias, preparar confirmación
             try {
                const pendingAfter = Array.from(document.querySelectorAll('#collection-items tr[data-code]'))
                   .filter(r => r.querySelector('.counted-cell') && r.querySelector('.counted-cell').dataset.counted === '');
                if (pendingAfter.length === 0 && hasDifferences()) {
                   window.__awaitDiffValidation = true; // se abrirá al cerrar mismatch
                }
             } catch(_){}
      }
      // Re-evaluar habilitación del botón finalizar tras cada conteo
      try { reevaluateFinalizeState(); } catch(_) {}
         // Auto-generar TRANSFER si ya no quedan items por chequear
         try {
             const remaining = Array.from(document.querySelectorAll('#collection-items tr[data-code]'))
                .filter(r => {
                   const cCell = r.querySelector('.counted-cell');
                   // Consideramos "por chequear" si no tiene conteo aplicado
                   return cCell && cCell.dataset.counted === '';
                });
            if (remaining.length === 0 && !window.__autoFinalized) {
               if (hasDifferences()) {
                  // Existen diferencias: requerir confirmación
                  if (!mismatchModal.classList.contains('flex')) { // si no hay mismatch abierto, abrir directamente
                     openDiffValidationModal();
                     window.__awaitDiffValidation = false; // ya mostrado
                  } else {
                     window.__awaitDiffValidation = true; // se mostrará tras cerrar mismatch
                  }
               } else {
                  window.__autoFinalized = true;
                  if (finalizeBtn) { finalizeBtn.disabled = false; finalizeBtn.click(); }
               }
            }
         } catch(_){}
   }

   function openMismatchModal(code, original, counted){
      if(!mismatchModal) return;
      const diff = Number(counted) - Number(original);
      mmwMessage.textContent = `El producto ${code} no cuadra con la cantidad de la orden.`;
      mmwDetail.textContent = `Cant. orden: ${Number(original).toFixed(3)} | Cant. contada: ${Number(counted).toFixed(3)} | Diferencia: ${diff.toFixed(3)}`;
      mismatchModal.classList.remove('hidden');
      mismatchModal.classList.add('flex');
      try { mmwClose.focus(); } catch(_){}
   }
   function closeMismatchModal(){
      if(!mismatchModal) return;
      mismatchModal.classList.add('hidden');
      mismatchModal.classList.remove('flex');
      // Si queda pendiente la confirmación por diferencias al final
      if (window.__awaitDiffValidation) {
         openDiffValidationModal();
         window.__awaitDiffValidation = false;
      }
   }
   mmwClose && mmwClose.addEventListener('click', ()=>{ closeMismatchModal(); searchInput && searchInput.focus(); });

   function openDiffValidationModal(){
      if (!diffValidationModal) return;
      diffValidationModal.classList.remove('hidden');
      diffValidationModal.classList.add('flex');
      try { diffNo.focus(); } catch(_){}
   }
   function closeDiffValidationModal(){
      if (!diffValidationModal) return;
      diffValidationModal.classList.add('hidden');
      diffValidationModal.classList.remove('flex');
   }
   diffYes && diffYes.addEventListener('click', ()=>{
      closeDiffValidationModal();
      // Proceder a validar (generar traslado) respetando flujo existente
      window.__autoFinalized = true; // evitar doble ejecución
      if (finalizeBtn) { finalizeBtn.disabled = false; finalizeBtn.click(); }
   });
   diffNo && diffNo.addEventListener('click', ()=>{
      closeDiffValidationModal();
      // Permitir seguir ajustando: mantener botón habilitado pero no auto-finalizar
      window.__awaitDiffValidation = false; // limpiar bandera
      setStatus('Continúa ajustando las cantidades antes de validar.', 'info');
      try { searchInput.focus(); } catch(_){}
   });

      applyBtn && applyBtn.addEventListener('click', async () => {
         let code = normalize(searchInput.value);
      const countedRaw = countedInput.value;
         if (!code){ setStatus('Ingresa un código primero', 'error'); return; }
         let row = findRowByCode(code);
         if (!row){
            // Intentar resolver como other_code
            try {
               const url = new URL('{{ url_for("api_collection_order_product_info") }}', window.location.origin);
               url.searchParams.set('query', code);
               const res = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
               if (res.ok){
                  const data = await res.json();
                  if (data && data.ok && data.code){
                     code = String(data.code);
                     row = findRowByCode(code);
                  }
               }
            } catch (e) { /* noop */ }
         }
         if (!row){ setStatus('Producto no encontrado en la orden', 'error'); return; }
      let countedVal = Number(String(countedRaw).replace(',', '.'));
      if (isNaN(countedVal) || countedVal < 0){ setStatus('Cantidad contada inválida', 'error'); return; }
      const original = Number(row.querySelector('[data-original]').dataset.original);

         if (correlative === null){ setStatus('No hay correlativo cargado.', 'error'); return; }
      try {
         const formData = new URLSearchParams();
            formData.set('correlative', correlative);
            formData.set('product_code', code);
         formData.set('counted', countedVal);
         const res = await fetch('{{ url_for("api_collection_order_update_count") }}', {
            method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded','X-Requested-With':'XMLHttpRequest'}, body: formData.toString()
         });
         const data = await res.json();
         if (!res.ok || !data.ok) throw new Error(data.error || 'Error en actualización');
         markRow(row, original, countedVal);
         setStatus('Conteo aplicado', 'success');
            // Limpiar inputs y devolver el foco al buscador para el siguiente conteo
            searchInput.value = '';
            countedInput.value = '';
            try { searchInput.focus(); } catch (e) {}
            // Re-evaluar estado del botón finalizar tras conteo
            try { reevaluateFinalizeState(); } catch(_) {}
      } catch(e){ setStatus(e.message, 'error'); }
   });

   finalizeBtn && finalizeBtn.addEventListener('click', async () => {
      if (correlative === null){ setStatus('Sin correlativo', 'error'); return; }
      finalizeBtn.disabled = true; setStatus('Generando TRANSFER ...');
      try {
         // Construir lista de códigos contados para validación en servidor
         const rows = Array.from(tableBody.querySelectorAll('tr[data-code]'));
         const countedCodes = rows.filter(r => {
            const cell = r.querySelector('.counted-cell');
            return cell && cell.dataset.counted !== '';
         }).map(r => r.dataset.code);
         const formData = new URLSearchParams();
         formData.set('correlative', correlative);
         formData.set('counted_codes', countedCodes.join(','));
         const res = await fetch('{{ url_for("api_collection_order_confirm_transfer") }}', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded','X-Requested-With':'XMLHttpRequest'}, body: formData.toString()});
         const data = await res.json();
         if (!res.ok || !data.ok) throw new Error(data.error || 'Error generando TRANSFER');
         setStatus('TRANSFER creada correlativo ' + data.transfer_correlative, 'success');
         // Abrir PDF de la TRANSFER en nueva pestaña
         const pdfUrl = '{{ url_for("collection_preview_pdf") }}' + '?correlative=' + data.transfer_correlative + '&operation_type=TRANSFER&wait=true';
         window.open(pdfUrl, '_blank');
         // Redireccionar a la pantalla de chequeo de orden para mostrar estado actualizado
         setTimeout(() => {
            window.location.href = '{{ url_for("check_order_collection") }}' + '?correlative=' + data.transfer_correlative;
         }, 600);
      } catch(e){ setStatus(e.message, 'error'); }
      finally { finalizeBtn.disabled = false; }
   });

   // Resaltar fila al buscar
   searchInput && searchInput.addEventListener('input', () => {
      const code = normalize(searchInput.value);
      Array.from(tableBody.querySelectorAll('tr')).forEach(tr => tr.classList.remove('ring','ring-indigo-300','collection-highlight'));
      if (!code) return;
      const row = findRowByCode(code);
      if (row){ row.classList.add('collection-highlight'); }
   });

   // Al presionar Enter en el buscador: resolver código (incluye other_code) y mover el foco a cantidad
   async function resolveToRow(code) {
      let row = findRowByCode(code);
      if (!row) {
         try {
            const url = new URL('{{ url_for("api_collection_order_product_info") }}', window.location.origin);
            url.searchParams.set('query', code);
            const res = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
            if (res.ok) {
               const data = await res.json();
               if (data && data.ok && data.code) {
                  code = String(data.code);
                  row = findRowByCode(code);
                  if (row) {
                     // actualizar input para que el siguiente paso opere con el code principal
                     searchInput.value = code;
                  }
               }
            }
         } catch (e) { /* noop */ }
      }
      return { row, code };
   }

   searchInput && searchInput.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') {
         e.preventDefault();
         const code = normalize(searchInput.value);
         if (!code) { setStatus('Ingresa un código primero', 'error'); return; }
         const result = await resolveToRow(code);
         if (!result.row) {
            // Consultar info del producto y abrir modal poblado
            try {
               const url = new URL('{{ url_for("api_collection_order_product_info") }}', window.location.origin);
               url.searchParams.set('query', code);
               const res = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
               const data = await res.json();
               if (!res.ok || !data.ok) { setStatus(data.error || 'Producto no encontrado', 'error'); return; }
               const modal = document.getElementById('add-item-modal');
               const codeInput = document.getElementById('add-code');
               const descInput = document.getElementById('add-description');
               const unitInput = document.getElementById('add-unit');
               const qtyInput = document.getElementById('add-quantity');
               const stockInput = document.getElementById('add-stock');
               const statusP = document.getElementById('add-item-status');
               // Poblar y también fijar atributo value como pides
               codeInput.value = data.code || '';
               codeInput.setAttribute('value', data.code || '');
               descInput.value = data.description || '';
               descInput.setAttribute('value', data.description || '');
               unitInput.value = data.unit_description || '';
               unitInput.setAttribute('value', data.unit_description || '');
               qtyInput.value = '';
               // Consultar stock en depósito de origen para el código principal
               try {
                  if (stockInput) {
                     stockInput.value = 'Consultando...';
                     const sUrl = new URL('{{ url_for("api_collection_order_product_stock") }}', window.location.origin);
                     sUrl.searchParams.set('correlative', correlative ?? '');
                     sUrl.searchParams.set('code', data.code || '');
                     const sRes = await fetch(sUrl.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                     const sData = await sRes.json();
                     if (!sRes.ok || !sData.ok) {
                        stockInput.value = 'N/D';
                     } else {
                        const sv = Number(sData.stock || 0);
                        stockInput.value = isNaN(sv) ? '0' : sv.toFixed(3);
                     }
                  }
               } catch (_) {
                  if (stockInput) stockInput.value = 'N/D';
               }
               statusP.textContent = '';
               modal.classList.remove('hidden');
               setTimeout(()=>{ try{ qtyInput.focus(); }catch(e){} }, 50);
            } catch (err) {
               setStatus('Error consultando producto', 'error');
            }
            return; 
         }
         // Resaltar y abrir modal de conteo
         Array.from(tableBody.querySelectorAll('tr')).forEach(tr => tr.classList.remove('ring','ring-indigo-300','collection-highlight'));
         result.row.classList.add('collection-highlight');
         openCountModal(result.row);
      }
   });

   // En cantidad contada, Enter: mover foco al botón Aplicar conteo (no ejecutar todavía)
   countedInput && countedInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
         e.preventDefault();
         applyBtn.focus();
      }
   });

   // En el botón aplicar, Enter ejecuta el click
   applyBtn && applyBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
         e.preventDefault();
         applyBtn.click();
      }
   });

   // Habilitar/Deshabilitar el botón Finalizar según conteos
   function allRowsCounted(){
      const rows = Array.from(tableBody.querySelectorAll('tr[data-code]'));
      if (rows.length === 0) return false; // no permitir sin items
      return rows.every(r => {
         const countedCell = r.querySelector('.counted-cell');
         return countedCell && countedCell.dataset.counted !== '';
      });
   }
   function reevaluateFinalizeState(){
      if (!finalizeBtn) return;
      finalizeBtn.disabled = !allRowsCounted();
   }
   // reevaluar al cargar
   reevaluateFinalizeState();

   // Eliminar producto de la orden (delegación)
   tableBody && tableBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('.delete-item');
      if (!btn) return;
      const code = btn.dataset.code;
      if (!code) return;
      if (!confirm(`¿Eliminar producto ${code} de la orden?`)) return;
      try {
         const res = await fetch('{{ url_for("api_collection_order_delete_item") }}', {
            method:'POST',
            headers:{'Content-Type':'application/x-www-form-urlencoded','X-Requested-With':'XMLHttpRequest'},
            body: new URLSearchParams({ correlative: String(correlative), product_code: code }).toString(),
         });
         const data = await res.json();
         if (!res.ok || !data.ok) throw new Error(data.error || 'No se pudo eliminar');
         const row = tableBody.querySelector(`tr[data-code="${code}"]`);
         if (row) row.remove();
         setStatus('Producto eliminado de la orden', 'success');
         reevaluateFinalizeState();
      } catch(err){ setStatus(err.message, 'error'); }
   });

   // Lógica modal agregar ítem
   const addModal = document.getElementById('add-item-modal');
   const addForm = document.getElementById('add-item-form');
   const addCancel = document.getElementById('add-cancel');
   const addStatus = document.getElementById('add-item-status');
   function closeAddModal(){ if (addModal) addModal.classList.add('hidden'); }
   addCancel && addCancel.addEventListener('click', () => { closeAddModal(); searchInput.focus(); });
   addForm && addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!correlative){ addStatus.textContent = 'Sin correlativo'; addStatus.className='text-sm text-red-600'; return; }
      const fd = new FormData(addForm);
      const q = fd.get('quantity');
      const codeVal = fd.get('product_code');
      if (!codeVal){ addStatus.textContent='Código vacío'; addStatus.className='text-sm text-red-600'; return; }
      let qty = Number(String(q||'').replace(',', '.'));
      if (isNaN(qty) || qty <= 0){ addStatus.textContent='Cantidad inválida'; addStatus.className='text-sm text-red-600'; return; }
         // Validación: no exceder stock disponible en origen
         try {
            const stockField = document.getElementById('add-stock');
            const stockVal = Number(String(stockField && stockField.value || '0').replace(',', '.'));
            if (!isNaN(stockVal) && qty > stockVal) {
               addStatus.textContent = `La cantidad (${qty}) no puede ser mayor al stock (${stockVal}).`;
               addStatus.className = 'text-sm text-red-600';
               return;
            }
         } catch(_){}
      try {
         addStatus.textContent='Agregando...'; addStatus.className='text-sm text-gray-600';
         const res = await fetch('{{ url_for("api_collection_order_add_item") }}', {
            method:'POST',
            headers:{'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
               correlative: String(correlative),
               product_code: String(codeVal),
               quantity: String(qty)
            }).toString(),
         });
         const data = await res.json();
         if (!res.ok || !data.ok){ throw new Error(data.error || 'Error agregando'); }
         // Añadir fila DOM
         const newRow = document.createElement('tr');
         newRow.dataset.code = data.added.code_product;
             newRow.innerHTML = `
                <td class="px-3 py-2 font-mono">${data.added.code_product}</td>
                <td class="px-3 py-2">${data.added.description_product || ''}</td>
                <td class="px-3 py-2">${data.added.unit_description || ''}</td>
                   <td class="px-3 py-2 text-right" data-original="${Number(data.added.amount).toFixed(2)}">${Number(data.added.amount).toFixed(2)}</td>
                <td class="px-3 py-2 text-right counted-cell" data-counted=""><span class="text-gray-400 italic">Sin conteo</span></td>
                <td class="px-3 py-2 text-right status-cell"><span class="inline-block px-2 py-1 rounded bg-gray-200 text-gray-700 text-xs">Pendiente</span></td>
                <td class="px-3 py-2 text-right"><button type="button" class="delete-item px-2 py-1 text-xs rounded bg-red-600 text-white" data-code="${data.added.code_product}">Eliminar</button></td>
             `;
         tableBody.appendChild(newRow);
         // Nuevo ítem agregado sin conteo: deshabilitar finalizar
         try { reevaluateFinalizeState(); } catch(_) {}
   
         addStatus.textContent='Agregado'; addStatus.className='text-sm text-green-600';
         setTimeout(()=>{ closeAddModal(); searchInput.value=''; countedInput.value=''; searchInput.focus(); }, 250);
         setStatus('Producto agregado a la orden', 'success');
      } catch(err){
         addStatus.textContent=err.message; addStatus.className='text-sm text-red-600';
         // También mostrar en status general si se desea
         setStatus(err.message, 'error');
      }
   });
});
</script>
{% endblock %}